---
title: "Synthetic Data"
author: "Hsuan Lee"
output: pdf_document
---
```{r}
setwd(paste("C:/Users/HsuanLee/Desktop/Methodology and Statistics/",
"Changepoints Inference in Relational Event Data of a Social Network/",
"Changepoint-Inference-in-REH-of-a-Social-Network", sep = ""))
```

# Simulate the REH
```{r}
# Install the needed packages

#install.packages("devtools")

#library(devtools)

#devtools::install_version("mvtnorm", version = "1.1-3", repos = "http://cran.us.r-project.org")

#devtools::install_github("TilburgNetworkGroup/remify@1a165e99a0ad784ead08974da86fb2a319f537dc")

#devtools::install_github("TilburgNetworkGroup/remstats@c6ef7c41c6b43891f760d2db7ad390e8035b83dc")

#devtools::install_github("TilburgNetworkGroup/remstimate@5ba940645929c4d9d84a4cf16fab68f8971a1a19")
```

```{r}
#devtools::install_github("mlmeijerink/REHdynamics")
```

```{r}
library(tidyverse)
library(REHdynamics) # generate the REH with CPs
library(remstats) # the formula for REH
library(remify)
library(relevent) # fit REH to REM
```

**REH with no CPs**

```{r}
set.seed(9252568)
# REH with only inertia statistics
# ??remstat -> to select the statistics
formula <- ~ 1 + remstats::send("z", covar) + # Exogenous statistics
  remstats::difference("z", covar) + # Exogenous statistics
  remstats::inertia(scaling = "std") + # Endogenous statistics
  remstats::outdegreeSender(scaling='std') # Endogenous statistics

# set up the covariates
covar <- data.frame(id = 1:30, time = 0, z = rnorm(n = 30))

# set up the value of parameters
param.ncp <- list(
  "baseline" = -8.8,
  "z_send"= 0.1, 
  "z_difference" = -0.1,
  "inertia" = 0.18,
  "outdegreeSender" = 0.12)

# create REH with 1 CP
reh_ncp <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_ncp[[i]] <- generate(formula = formula, param = param.ncp, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
library(matrixStats) # for rowMaxs
```

```{r}
# compute the statistics
out.ncp <- remstats(tie_effects = formula, edgelist = reh_ncp) # also will be used for fitting REM
stat.ncp <- out.ncp[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of inertia
ine_ncp <- stat.ncp[,,"inertia"]

# aggregate the statistics of each time point
ine_ncp.agg.max <- rowMaxs(ine_ncp)
plot(ine_ncp.agg.max, type = "lm")

ine_ncp.agg.mean <- rowMeans(ine_ncp)
plot(ine_ncp.agg.mean, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
library(ocp) # package for BOCD
```

```{r}
BOCD_ine_ncp.agg.mean <- onlineCPD(ine_ncp.agg.mean, getR = T, optionalOutputs = T, truncRlim = 10^-6)
BOCD_ine_ncp.agg.mean[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_ncp.agg.mean)

BOCD_ine_ncp.agg.max <- onlineCPD(ine_ncp.agg.max, getR = T, optionalOutputs = T, truncRlim = 10^-6)
BOCD_ine_ncp.agg.max[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_ncp.agg.max)
```

2. PELT: Exact CPs Detection Method
```{r}
library(changepoint) # package for PELT
```

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_ncp.agg.mean <- cpt.var(ine_ncp.agg.mean, method="PELT")
summary(PELT_ine_ncp.agg.mean)

# plot the location of detected CPs
plot(ine_ncp.agg.mean, type="point", col = "black")
abline(v=PELT_ine_ncp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_ncp.agg.max <- cpt.var(ine_ncp.agg.max, method="PELT")
summary(PELT_ine_ncp.agg.max)

# plot the location of detected CPs
plot(ine_ncp.agg.max, type="point", col = "black")
abline(v=PELT_ine_ncp.agg.max@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
library(changepoint) # package for BS
```

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_ncp.agg.mean <- cpt.meanvar(ine_ncp.agg.mean, method = "BinSeg")
cpts(BS_ine_ncp.agg.mean)

# plot the location of CPs
plot(ine_ncp.agg.mean)
abline(v=BS_ine_ncp.agg.mean@cpts[], col="black")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_ncp.agg.max <- cpt.meanvar(ine_ncp.agg.max, method = "BinSeg")
cpts(BS_ine_ncp.agg.max)

# plot the location of CPs
plot(ine_ncp.agg.max)
abline(v=BS_ine_ncp.agg.max@cpts[], col="black")
```

4. Wild BS
```{r}
library(wbs) # package for WBS
```

- Mean
```{r}
WBS_ine_ncp.agg.mean <- wbs(ine_ncp.agg.mean)
changepoints(WBS_ine_ncp.agg.mean)
plot(WBS_ine_ncp.agg.mean)
```

- Max
```{r}
WBS_ine_ncp.agg.max <- wbs(ine_ncp.agg.max)
changepoints(WBS_ine_ncp.agg.max)
plot(WBS_ine_ncp.agg.max)
```

*Create function that aggregates the top 5% of maximum statistics by timepoints*
```{r}
max_mean_time <- 
  function(statistics,
           # percentage of maximum values contained in the aggregation each timepoint
           percent = 0.05){
  # transpose the matrix to let time point as column
  statistics.transpose <- data.frame(t(statistics))
  
  maxs_mean_time <- 0
  # arrange the order of statistics in each time point
  for (time in 1:nrow(statistics)) {
    # extract the statistics by timepoint
    timepoint <- statistics.transpose[,time]
    # arrange the order of statistics of each timepoint
    stat_order <- data.frame(sort(timepoint, decreasing = T))
    # extract and mean the top 5% maximum statistics of each time point
    maxs_mean_time[time] <- mean(stat_order[1:(percent*nrow(statistics)),1])
  }
  results <- list(means_max.values_each_timepoint = maxs_mean_time)
  return(results)
}
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_ncp <- max_mean_time(ine_ncp, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_ncp) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_ine_ncp.agg.top <- onlineCPD(top_ine_ncp, getR = T, optionalOutputs = T, truncRlim = 10^-6)
BOCD_ine_ncp.agg.top[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_ncp.agg.top)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_ncp.agg.top <- cpt.var(top_ine_ncp, method="PELT")
summary(PELT_ine_ncp.agg.top)

# plot the location of detected CPs
plot(top_ine_ncp, type="l", col = "red")
abline(v=PELT_ine_ncp.agg.top@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_ncp.agg.top <- cpt.meanvar(top_ine_ncp, method = "BinSeg")
cpts(BS_ine_ncp.agg.top)

# plot the location of CPs
plot(top_ine_ncp)
abline(v=BS_ine_ncp.agg.top@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ine_ncp.agg.top <- wbs(top_ine_ncp)
changepoints(WBS_ine_ncp.agg.top)
plot(WBS_ine_ncp.agg.top)
```

*Fit the Data-Driven MW REM on the REH with no CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_ncp <- reh_ncp[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_ncp, file = "REH_NCP.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_ncp <- ddwindows(edgelist = reh_ncp, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_ncp <- MWrem(windows = ddwin_ncp$windows, edgelist = reh_ncp, 
		stats = stat.ncp, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_ine_ncp_param <- 1
for (i in 1:length(model_ddwin_ncp)) {
  ddmw_ine_ncp_param[i] <- model_ddwin_ncp[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_ncp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_ine_ncp_param <- onlineCPD(ddmw_ine_ncp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_ncp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_ncp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_ine_ncp_param <- cpt.var(ddmw_ine_ncp_param, method="PELT")
summary(PELT_ddmw_ine_ncp_param)

# plot the location of CPs
plot(ddmw_ine_ncp_param, type="l", col = "red")
abline(v=PELT_ddmw_ine_ncp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_ncp_param <- cpt.meanvar(ddmw_ine_ncp_param, method = "BinSeg")
cpts(BS_ddmw_ine_ncp_param)

# plot the location of CPs
plot(ddmw_ine_ncp_param)
abline(v=BS_ddmw_ine_ncp_param@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_ine_ncp_param <- wbs(ddmw_ine_ncp_param)
changepoints(WBS_ddmw_ine_ncp_param)
plot(WBS_ddmw_ine_ncp_param)
```

*Fit the Fixed MW REM on the REH with No CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_ncp$time)

# specify the length of the window
windows_ncp <- REHdynamics::createwindows(1400, tau)

# fit to the REM model
model_fixwin_ncp <- REHdynamics::MWrem(windows, edgelist = reh_ncp, 
                                       stats = stat.ncp,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_ncp_param <- 1
for (i in 1:length(model_fixwin_ncp)) {
  fixmw_send_ncp_param[i] <- model_fixwin_ncp[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_ncp_param, type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_ncp_param <- 1
for (i in 1:length(model_fixwin_ncp)) {
  fixmw_diff_ncp_param[i] <- model_fixwin_ncp[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_ncp_param, type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_ncp_param <- 1
for (i in 1:length(model_fixwin_ncp)) {
  fixmw_ine_ncp_param[i] <- model_fixwin_ncp[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_ncp_param, type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_ncp_param <- 1
for (i in 1:length(model_fixwin_ncp)) {
  fixmw_out_ncp_param[i] <- model_fixwin_ncp[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_ncp_param, type = "point") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_ncp_param <- onlineCPD(fixmw_send_ncp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_ncp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_ncp_param)
```

```{r}
BOCD_fixmw_diff_ncp_param <- onlineCPD(fixmw_diff_ncp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_ncp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_ncp_param)
```

```{r}
BOCD_fixmw_ine_ncp_param <- onlineCPD(fixmw_ine_ncp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_ncp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_ncp_param)
```

```{r}
BOCD_fixmw_out_ncp_param <- onlineCPD(fixmw_out_ncp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_ncp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_ncp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_ine_ncp_param <- cpt.meanvar(fixmw_ine_ncp_param, method="PELT")
summary(PELT_fixmw_ine_ncp_param)

# plot the location of CPs
plot(fixmw_ine_ncp_param, type="point", col = "red")
abline(v=PELT_fixmw_ine_ncp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_ncp_param <- cpt.meanvar(fixmw_ine_ncp_param, method = "BinSeg")
cpts(BS_fixmw_ine_ncp_param)

# plot the location of CPs
plot(fixmw_ine_ncp_param, type = "l")
abline(v=BS_fixmw_ine_ncp_param@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_ine_ncp_param <- wbs(fixmw_ine_ncp_param)
changepoints(WBS_fixmw_ine_ncp_param)
plot(WBS_fixmw_ine_ncp_param)
```

**REH with 1 CP for inertia, none for the rest**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.1cp <- list(
  "baseline" = -8.8,
  "z_send"= 0.12, 
  "z_difference" = -0.1,
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 38200) { #5955
      0.13
    } else  {
      0.08}
  },
  
  "outdegreeSender" = 0.12
)

# create REH with 1 CP
reh_1cp <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_1cp[[i]] <- generate(formula = formula, param = param.1cp, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.1cp <- remstats(tie_effects = formula, edgelist = reh_1cp) # also will be used for fitting REM
stat.1cp <- out.1cp[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of inertia
ine_1cp <- stat.1cp[,,4]

# aggregate the statistics of each time point
ine_1cp.agg.max <- rowMaxs(ine_1cp)
plot(ine_1cp.agg.max, type = "lm")

ine_1cp.agg.mean <- rowMeans(ine_1cp)
plot(ine_1cp.agg.mean, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ine_1cp.agg.mean <- onlineCPD(ine_1cp.agg.mean, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.mean[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.mean)

BOCD_ine_1cp.agg.max <- onlineCPD(ine_1cp.agg.max, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.max[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.max)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.mean <- cpt.var(ine_1cp.agg.mean, method="PELT")
summary(PELT_ine_1cp.agg.mean)

# plot the location of detected CPs
plot(ine_1cp.agg.mean, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.max <- cpt.var(ine_1cp.agg.max, method="PELT")
summary(PELT_ine_1cp.agg.max)

# plot the location of detected CPs
plot(ine_1cp.agg.max, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.max@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.mean <- cpt.meanvar(ine_1cp.agg.mean, method = "BinSeg")
cpts(BS_ine_1cp.agg.mean)

# plot the location of CPs
plot(ine_1cp.agg.mean)
abline(v=BS_ine_1cp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.max <- cpt.meanvar(ine_1cp.agg.max, method = "BinSeg")
cpts(BS_ine_1cp.agg.max)

# plot the location of CPs
plot(ine_1cp.agg.max)
abline(v=BS_ine_1cp.agg.max@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_ine_1cp.agg.mean <- wbs(ine_1cp.agg.mean)
changepoints(WBS_ine_1cp.agg.mean)
plot(WBS_ine_1cp.agg.mean)
```

- Max
```{r}
WBS_ine_1cp.agg.max <- wbs(ine_1cp.agg.max)
changepoints(WBS_ine_1cp.agg.max)
plot(WBS_ine_1cp.agg.max)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_1cp <- max_mean_time(ine_1cp, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_1cp) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_ine_1cp.agg.top <- onlineCPD(top_ine_1cp, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.top[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.top)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.top <- cpt.var(top_ine_1cp, method="PELT")
summary(PELT_ine_1cp.agg.top)

# plot the location of detected CPs
plot(top_ine_1cp, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.top@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.top <- cpt.meanvar(top_ine_1cp, method = "BinSeg")
cpts(BS_ine_1cp.agg.top)

# plot the location of CPs
plot(top_ine_1cp)
abline(v=BS_ine_1cp.agg.top@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_ine_1cp.agg.top <- wbs(top_ine_1cp)
changepoints(WBS_ine_1cp.agg.top)
plot(WBS_ine_1cp.agg.top)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_1cp <- reh_1cp[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_1cp, file = "REH_1CP.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_1cp <- ddwindows(edgelist = reh_1cp, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_1cp <- MWrem(windows = ddwin_1cp$windows, edgelist = reh_1cp, 
		stats = stat.1cp, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_ine_1cp_param <- 1
for (i in 1:length(model_ddwin_1cp)) {
  ddmw_ine_1cp_param[i] <- model_ddwin_1cp[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_1cp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_ine_1cp_param <- onlineCPD(ddmw_ine_1cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_1cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_1cp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_ine_1cp_param <- cpt.var(ddmw_ine_1cp_param, method="PELT")
summary(PELT_ddmw_ine_1cp_param)

# plot the location of CPs
plot(ddmw_ine_1cp_param, type="l", col = "red")
abline(v=PELT_ddmw_ine_1cp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_1cp_param <- cpt.meanvar(ddmw_ine_1cp_param, method = "BinSeg")
cpts(BS_ddmw_ine_1cp_param)

# plot the location of CPs
plot(ddmw_ine_1cp_param)
abline(v=BS_ddmw_ine_1cp_param@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_ine_1cp_param <- wbs(ddmw_ine_1cp_param)
changepoints(WBS_ddmw_ine_1cp_param)
plot(WBS_ddmw_ine_1cp_param)
```

*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_1cp$time)

# specify the length of the window
windows_1cp <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_1cp <- REHdynamics::MWrem(windows_1cp, edgelist = reh_1cp, 
                                       stats = stat.1cp,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_1cp_param <- 1
for (i in 1:length(model_fixwin_1cp)) {
  fixmw_send_1cp_param[i] <- model_fixwin_1cp[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_1cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_1cp_param <- 1
for (i in 1:length(model_fixwin_1cp)) {
  fixmw_diff_1cp_param[i] <- model_fixwin_1cp[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_1cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_1cp_param <- 1
for (i in 1:length(model_fixwin_1cp)) {
  fixmw_ine_1cp_param[i] <- model_fixwin_1cp[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_1cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_1cp_param <- 1
for (i in 1:length(model_fixwin_1cp)) {
  fixmw_out_1cp_param[i] <- model_fixwin_1cp[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_1cp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_1cp_param <- onlineCPD(fixmw_send_1cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_1cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_1cp_param)
```

```{r}
BOCD_fixmw_diff_1cp_param <- onlineCPD(fixmw_diff_1cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_1cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_1cp_param)
```

```{r}
BOCD_fixmw_ine_1cp_param <- onlineCPD(fixmw_ine_1cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_1cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_1cp_param)
```

```{r}
BOCD_fixmw_out_1cp_param <- onlineCPD(fixmw_out_1cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_1cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_1cp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_1cp_param <- cpt.meanvar(fixmw_send_1cp_param, method="PELT")
summary(PELT_fixmw_send_1cp_param)

# plot the location of CPs
plot(fixmw_send_1cp_param, type="l", col = "red")
abline(v=PELT_fixmw_send_1cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_1cp_param <- cpt.meanvar(fixmw_diff_1cp_param, method="PELT")
summary(PELT_fixmw_diff_1cp_param)

# plot the location of CPs
plot(fixmw_diff_1cp_param, type="l", col = "red")
abline(v=PELT_fixmw_diff_1cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_1cp_param <- cpt.meanvar(fixmw_ine_1cp_param, method="PELT")
summary(PELT_fixmw_ine_1cp_param)

# plot the location of CPs
plot(fixmw_ine_1cp_param, type="l", col = "red")
abline(v=PELT_fixmw_ine_1cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_out_1cp_param <- cpt.meanvar(fixmw_out_1cp_param, method="PELT")
summary(PELT_fixmw_out_1cp_param)

# plot the location of CPs
plot(fixmw_out_1cp_param, type="l", col = "red")
abline(v=PELT_fixmw_out_1cp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_1cp_param <- cpt.meanvar(fixmw_send_1cp_param, method = "BinSeg")
cpts(BS_fixmw_send_1cp_param)

# plot the location of CPs
plot(fixmw_send_1cp_param)
abline(v=BS_fixmw_send_1cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_1cp_param <- cpt.meanvar(fixmw_diff_1cp_param, method = "BinSeg")
cpts(BS_fixmw_diff_1cp_param)

# plot the location of CPs
plot(fixmw_diff_1cp_param)
abline(v=BS_fixmw_diff_1cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_1cp_param <- cpt.meanvar(fixmw_ine_1cp_param, method = "BinSeg")
cpts(BS_fixmw_ine_1cp_param)

# plot the location of CPs
plot(fixmw_ine_1cp_param)
abline(v=BS_fixmw_ine_1cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_1cp_param <- cpt.meanvar(fixmw_out_1cp_param, method = "BinSeg")
cpts(BS_fixmw_out_1cp_param)

# plot the location of CPs
plot(fixmw_out_1cp_param)
abline(v=BS_fixmw_out_1cp_param@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_ine_1cp_param <- wbs(fixmw_ine_1cp_param)
changepoints(WBS_fixmw_ine_1cp_param)
plot(WBS_fixmw_ine_1cp_param)
```

**REH with 1 CP for all the statistics (at same location)**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.1cp_same.all <- list(
  "baseline" = -8.8,
  
  "z_send"= function(t) {
    # set the location of CP
    if(t < 38200) { #8366
      0.18
    } else  {
      0.04}
  },
  
  "z_difference" = function(t) {
    # set the location of CP
    if(t < 38200) { #8366
      -0.05
    } else  {
      -0.15}
  },
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 38200) { #8366
      0.13
    } else  {
      0.06}
  },
  
  "outdegreeSender" = function(t) {
    # set the location of CP
    if(t < 38200) { #8366
      0.13
    } else  {
      0.07}
  }
)

# create REH with 1 CP
reh_1cp_same.all <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_1cp_same.all[[i]] <- generate(formula = formula, param = param.1cp_same.all, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.1cp_same.all <- remstats(tie_effects = formula, edgelist = reh_1cp_same.all) # also will be used for fitting REM
stat.1cp_same.all <- out.1cp_same.all[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of send
send_1cp_same.all <- stat.1cp_same.all[,,2]

# aggregate the statistics of each time point
send_1cp.agg.max_same.all <- rowMaxs(send_1cp_same.all)
plot(send_1cp.agg.max_same.all, type = "lm")

send_1cp.agg.mean_same.all <- rowMeans(send_1cp_same.all)
plot(send_1cp.agg.mean_same.all, type = "lm")
```

```{r}
# extract the statistics of diff
diff_1cp_same.all <- stat.1cp_same.all[,,3]

# aggregate the statistics of each time point
diff_1cp.agg.max_same.all <- rowMaxs(diff_1cp_same.all)
plot(diff_1cp.agg.max_same.all, type = "lm")

diff_1cp.agg.mean_same.all <- rowMeans(diff_1cp_same.all)
plot(diff_1cp.agg.mean_same.all, type = "lm")
```

```{r}
# extract the statistics of inertia
ine_1cp_same.all <- stat.1cp_same.all[,,4]

# aggregate the statistics of each time point
ine_1cp.agg.max_same.all <- rowMaxs(ine_1cp_same.all)
plot(ine_1cp.agg.max_same.all, type = "lm")

ine_1cp.agg.mean_same.all <- rowMeans(ine_1cp_same.all)
plot(ine_1cp.agg.mean_same.all, type = "lm")
```

```{r}
# extract the statistics of diff
reci_1cp_same.all <- stat.1cp_same.all[,,5]

# aggregate the statistics of each time point
reci_1cp.agg.max_same.all <- rowMaxs(reci_1cp_same.all)
plot(reci_1cp.agg.max_same.all, type = "lm")

reci_1cp.agg.mean_same.all <- rowMeans(reci_1cp_same.all)
plot(reci_1cp.agg.mean_same.all, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_send_1cp.agg.mean_same.all <- onlineCPD(send_1cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_send_1cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_1cp.agg.mean_same.all)

BOCD_send_1cp.agg.max_same.all <- onlineCPD(send_1cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_1cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_1cp.agg.max_same.all)
```

```{r}
BOCD_diff_1cp.agg.mean_same.all <- onlineCPD(diff_1cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_diff_1cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_1cp.agg.mean_same.all)

BOCD_diff_1cp.agg.max_same.all <- onlineCPD(diff_1cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_1cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_1cp.agg.max_same.all)
```

```{r}
BOCD_ine_1cp.agg.mean_same.all <- onlineCPD(ine_1cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_ine_1cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.mean_same.all)

BOCD_ine_1cp.agg.max_same.all <- onlineCPD(ine_1cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.max_same.all)
```

```{r}
BOCD_reci_1cp.agg.mean_same.all <- onlineCPD(reci_1cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_reci_1cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_1cp.agg.mean_same.all)

BOCD_reci_1cp.agg.max_same.all <- onlineCPD(reci_1cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_1cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_1cp.agg.max_same.all)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_1cp.agg.mean_same.all <- cpt.var(send_1cp.agg.mean_same.all, method="PELT")
summary(PELT_send_1cp.agg.mean_same.all)

# plot the location of detected CPs
plot(send_1cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_send_1cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_1cp.agg.mean_same.all <- cpt.var(diff_1cp.agg.mean_same.all, method="PELT")
summary(PELT_diff_1cp.agg.mean_same.all)

# plot the location of detected CPs
plot(diff_1cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_diff_1cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.mean_same.all <- cpt.var(ine_1cp.agg.mean_same.all, method="PELT")
summary(PELT_ine_1cp.agg.mean_same.all)

# plot the location of detected CPs
plot(ine_1cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_1cp.agg.mean_same.all <- cpt.var(reci_1cp.agg.mean_same.all, method="PELT")
summary(PELT_reci_1cp.agg.mean_same.all)

# plot the location of detected CPs
plot(reci_1cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_reci_1cp.agg.mean_same.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_1cp.agg.max_same.all <- cpt.var(send_1cp.agg.max_same.all, method="PELT")
summary(PELT_send_1cp.agg.max_same.all)

# plot the location of detected CPs
plot(send_1cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_send_1cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_1cp.agg.max_same.all <- cpt.var(diff_1cp.agg.max_same.all, method="PELT")
summary(PELT_diff_1cp.agg.max_same.all)

# plot the location of detected CPs
plot(diff_1cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_diff_1cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.max_same.all <- cpt.var(ine_1cp.agg.max_same.all, method="PELT")
summary(PELT_ine_1cp.agg.max_same.all)

# plot the location of detected CPs
plot(ine_1cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_1cp.agg.max_same.all <- cpt.var(reci_1cp.agg.max_same.all, method="PELT")
summary(PELT_reci_1cp.agg.max_same.all)

# plot the location of detected CPs
plot(reci_1cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_reci_1cp.agg.max_same.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_1cp.agg.mean_same.all <- cpt.var(send_1cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_send_1cp.agg.mean_same.all)

# plot the location of CPs
plot(send_1cp.agg.mean_same.all)
abline(v=BS_send_1cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_1cp.agg.mean_same.all <- cpt.var(diff_1cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_diff_1cp.agg.mean_same.all)

# plot the location of CPs
plot(diff_1cp.agg.mean_same.all)
abline(v=BS_diff_1cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.mean_same.all <- cpt.var(ine_1cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_ine_1cp.agg.mean_same.all)

# plot the location of CPs
plot(ine_1cp.agg.mean_same.all)
abline(v=BS_ine_1cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_1cp.agg.mean_same.all <- cpt.var(reci_1cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_reci_1cp.agg.mean_same.all)

# plot the location of CPs
plot(reci_1cp.agg.mean_same.all)
ablreci(v=BS_reci_1cp.agg.mean_same.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_1cp.agg.max_same.all <- cpt.var(send_1cp.agg.max_same.all, method = "BinSeg")
cpts(BS_send_1cp.agg.max_same.all)

# plot the location of CPs
plot(send_1cp.agg.max_same.all)
abline(v=BS_send_1cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_1cp.agg.max_same.all <- cpt.var(diff_1cp.agg.max_same.all, method = "BinSeg")
cpts(BS_diff_1cp.agg.max_same.all)

# plot the location of CPs
plot(diff_1cp.agg.max_same.all)
abline(v=BS_diff_1cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.max_same.all <- cpt.var(ine_1cp.agg.max_same.all, method = "BinSeg")
cpts(BS_ine_1cp.agg.max_same.all)

# plot the location of CPs
plot(ine_1cp.agg.max_same.all)
abline(v=BS_ine_1cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_1cp.agg.max_same.all <- cpt.var(reci_1cp.agg.max_same.all, method = "BinSeg")
cpts(BS_reci_1cp.agg.max_same.all)

# plot the location of CPs
plot(reci_1cp.agg.max_same.all)
abline(v=BS_diff_1cp.agg.max_same.all@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_send_1cp.agg.mean_same.all <- wbs(send_1cp.agg.mean_same.all)
changepoints(WBS_send_1cp.agg.mean_same.all)
plot(WBS_send_1cp.agg.mean_same.all)
```

```{r}
WBS_diff_1cp.agg.mean_same.all <- wbs(diff_1cp.agg.mean_same.all)
changepoints(WBS_diff_1cp.agg.mean_same.all)
plot(WBS_diff_1cp.agg.mean_same.all)
```

```{r}
WBS_ine_1cp.agg.mean_same.all <- wbs(ine_1cp.agg.mean_same.all)
changepoints(WBS_ine_1cp.agg.mean_same.all)
plot(WBS_ine_1cp.agg.mean_same.all)
```

```{r}
WBS_reci_1cp.agg.mean_same.all <- wbs(reci_1cp.agg.mean_same.all)
changepoints(WBS_reci_1cp.agg.mean_same.all)
plot(WBS_reci_1cp.agg.mean_same.all)
```

- Max
```{r}
WBS_send_1cp.agg.max_same.all <- wbs(send_1cp.agg.max_same.all)
changepoints(WBS_send_1cp.agg.max_same.all)
plot(WBS_send_1cp.agg.max_same.all)
```

```{r}
WBS_diff_1cp.agg.max_same.all <- wbs(diff_1cp.agg.max_same.all)
changepoints(WBS_diff_1cp.agg.max_same.all)
plot(WBS_diff_1cp.agg.max_same.all)
```

```{r}
WBS_ine_1cp.agg.max_same.all <- wbs(ine_1cp.agg.max_same.all)
changepoints(WBS_ine_1cp.agg.max_same.all)
plot(WBS_ine_1cp.agg.max_same.all)
```

```{r}
WBS_reci_1cp.agg.max_same.all <- wbs(reci_1cp.agg.max_same.all)
changepoints(WBS_reci_1cp.agg.max_same.all)
plot(WBS_reci_1cp.agg.max_same.all)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_send_1cp_same.all <- max_mean_time(send_1cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_send_1cp_same.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_diff_1cp_same.all <- max_mean_time(diff_1cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_diff_1cp_same.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_1cp_same.all <- max_mean_time(ine_1cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_1cp_same.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_reci_1cp_same.all <- max_mean_time(reci_1cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_reci_1cp_same.all) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_send_1cp.agg.top_same.all <- onlineCPD(top_send_1cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_1cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_1cp.agg.top_same.all)
```

```{r}
# test the CPs
BOCD_diff_1cp.agg.top_same.all <- onlineCPD(top_diff_1cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_1cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_1cp.agg.top_same.all)
```

```{r}
# test the CPs
BOCD_ine_1cp.agg.top_same.all <- onlineCPD(top_ine_1cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.top_same.all)
```

```{r}
# test the CPs
BOCD_reci_1cp.agg.top_same.all <- onlineCPD(top_reci_1cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_1cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_1cp.agg.top_same.all)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_1cp.agg.top_same.all <- cpt.var(top_send_1cp_same.all, method="PELT")
summary(PELT_send_1cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_send_1cp_same.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_1cp.agg.top_same.all <- cpt.var(top_diff_1cp_same.all, method="PELT")
summary(PELT_diff_1cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_diff_1cp_same.all, type="point", col = "black")
abline(v=PELT_diff_1cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.top_same.all <- cpt.var(top_ine_1cp_same.all, method="PELT")
summary(PELT_ine_1cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_ine_1cp_same.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_1cp.agg.top_same.all <- cpt.var(top_reci_1cp_same.all, method="PELT")
summary(PELT_reci_1cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_reci_1cp_same.all, type="point", col = "black")
abline(v=PELT_reci_1cp.agg.top_same.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_1cp.agg.top_same.all <- cpt.meanvar(top_send_1cp_same.all, method = "BinSeg")
cpts(BS_send_1cp.agg.top_same.all)

# plot the location of CPs
plot(top_send_1cp_same.all)
abline(v=BS_send_1cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_1cp.agg.top_same.all <- cpt.meanvar(top_diff_1cp_same.all, method = "BinSeg")
cpts(BS_diff_1cp.agg.top_same.all)

# plot the location of CPs
plot(top_diff_1cp_same.all)
abline(v=BS_diff_1cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.top_same.all <- cpt.meanvar(top_ine_1cp_same.all, method = "BinSeg")
cpts(BS_ine_1cp.agg.top_same.all)

# plot the location of CPs
plot(top_ine_1cp_same.all)
abline(v=BS_ine_1cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_1cp.agg.top_same.all <- cpt.meanvar(top_reci_1cp_same.all, method = "BinSeg")
cpts(BS_reci_1cp.agg.top_same.all)

# plot the location of CPs
plot(top_reci_1cp_same.all)
abline(v=BS_reci_1cp.agg.top_same.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_send_1cp.agg.top <- wbs(top_send_1cp_same.all)
changepoints(WBS_send_1cp.agg.top_same.all)
plot(WBS_send_1cp.agg.top_same.all)
```

```{r}
WBS_diff_1cp.agg.top <- wbs(top_diff_1cp_same.all)
changepoints(WBS_diff_1cp.agg.top_same.all)
plot(WBS_diff_1cp.agg.top_same.all)
```

```{r}
WBS_ine_1cp.agg.top <- wbs(top_ine_1cp_same.all)
changepoints(WBS_ine_1cp.agg.top_same.all)
plot(WBS_ine_1cp.agg.top_same.all)
```

```{r}
WBS_reci_1cp.agg.top <- wbs(top_reci_1cp_same.all)
changepoints(WBS_reci_1cp.agg.top_same.all)
plot(WBS_reci_1cp.agg.top_same.all)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_1cp_same.all <- reh_1cp_same.all[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_1cp_same.all, file = "REH_1CP_same.all.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_1cp_same.all <- ddwindows(edgelist = reh_1cp_same.all, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_1cp_same.all <- MWrem(windows = ddwin_1cp_same.all$windows, edgelist = reh_1cp_same.all, 
		stats = stat.1cp_same.all, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_1cp_param_same.all <- 1
for (i in 1:length(model_ddwin_1cp_same.all)) {
  ddmw_send_1cp_param_same.all[i] <- model_ddwin_1cp_same.all[[i]][["coefficients"]][["send.z"]]
}
plot(ddmw_send_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_1cp_param_same.all <- 1
for (i in 1:length(model_ddwin_1cp_same.all)) {
  ddmw_diff_1cp_param_same.all[i] <- model_ddwin_1cp_same.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_1cp_param_same.all <- 1
for (i in 1:length(model_ddwin_1cp_same.all)) {
  ddmw_ine_1cp_param_same.all[i] <- model_ddwin_1cp_same.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_1cp_param_same.all <- 1
for (i in 1:length(model_ddwin_1cp_same.all)) {
  ddmw_reci_1cp_param_same.all[i] <- model_ddwin_1cp_same.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_send_1cp_param_same.all <- onlineCPD(ddmw_send_1cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_send_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_send_1cp_param_same.all)
```

```{r}
BOCD_ddmw_diff_1cp_param_same.all <- onlineCPD(ddmw_diff_1cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_diff_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_diff_1cp_param_same.all)
```

```{r}
BOCD_ddmw_ine_1cp_param_same.all <- onlineCPD(ddmw_ine_1cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_1cp_param_same.all)
```

```{r}
BOCD_ddmw_reci_1cp_param_same.all <- onlineCPD(ddmw_reci_1cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_reci_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_reci_1cp_param_same.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_send_1cp_param_same.all <- cpt.var(ddmw_send_1cp_param_same.all, method="PELT")
summary(PELT_ddmw_send_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_send_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_send_1cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_ddmw_diff_1cp_param_same.all <- cpt.var(ddmw_diff_1cp_param_same.all, method="PELT")
summary(PELT_ddmw_diff_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_diff_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_diff_1cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_ddmw_ine_1cp_param_same.all <- cpt.var(ddmw_ine_1cp_param_same.all, method="PELT")
summary(PELT_ddmw_ine_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_ine_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_ine_1cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_ddmw_reci_1cp_param_same.all <- cpt.var(ddmw_reci_1cp_param_same.all, method="PELT")
summary(PELT_ddmw_reci_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_reci_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_reci_1cp_param_same.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_send_1cp_param_same.all <- cpt.var(ddmw_send_1cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_send_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_send_1cp_param_same.all)
abline(v=BS_ddmw_send_1cp_param_same.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_diff_1cp_param_same.all <- cpt.var(ddmw_diff_1cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_diff_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_diff_1cp_param_same.all)
abline(v=BS_ddmw_diff_1cp_param_same.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_1cp_param_same.all <- cpt.var(ddmw_ine_1cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_ine_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_ine_1cp_param_same.all)
abline(v=BS_ddmw_ine_1cp_param_same.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_reci_1cp_param_same.all <- cpt.var(ddmw_reci_1cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_reci_1cp_param_same.all)

# plot the location of CPs
plot(ddmw_reci_1cp_param_same.all)
abline(v=BS_ddmw_reci_1cp_param_same.all@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_send_1cp_param_same.all <- wbs(ddmw_send_1cp_param_same.all)
changepoints(WBS_ddmw_send_1cp_param_same.all)
plot(WBS_ddmw_send_1cp_param_same.all)
```

```{r}
WBS_ddmw_diff_1cp_param_same.all <- wbs(ddmw_diff_1cp_param_same.all)
changepoints(WBS_ddmw_diff_1cp_param_same.all)
plot(WBS_ddmw_diff_1cp_param_same.all)
```

```{r}
WBS_ddmw_ine_1cp_param_same.all <- wbs(ddmw_ine_1cp_param_same.all)
changepoints(WBS_ddmw_ine_1cp_param_same.all)
plot(WBS_ddmw_ine_1cp_param_same.all)
```

```{r}
WBS_ddmw_reci_1cp_param_same.all <- wbs(ddmw_reci_1cp_param_same.all)
changepoints(WBS_ddmw_reci_1cp_param_same.all)
plot(WBS_ddmw_reci_1cp_param_same.all)
```

*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_1cp_same.all$time)

# specify the length of the window
windows_1cp_same.all <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_1cp_same.all <- REHdynamics::MWrem(windows_1cp_same.all, edgelist = reh_1cp_same.all, 
                                       stats = stat.1cp_same.all,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_1cp_param_same.all <- 1
for (i in 1:length(model_fixwin_1cp_same.all)) {
  fixmw_send_1cp_param_same.all[i] <- model_fixwin_1cp_same.all[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_1cp_param_same.all <- 1
for (i in 1:length(model_fixwin_1cp_same.all)) {
  fixmw_diff_1cp_param_same.all[i] <- model_fixwin_1cp_same.all[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_1cp_param_same.all <- 1
for (i in 1:length(model_fixwin_1cp_same.all)) {
  fixmw_ine_1cp_param_same.all[i] <- model_fixwin_1cp_same.all[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_1cp_param_same.all <- 1
for (i in 1:length(model_fixwin_1cp_same.all)) {
  fixmw_out_1cp_param_same.all[i] <- model_fixwin_1cp_same.all[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_1cp_param_same.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_1cp_param_same.all <- onlineCPD(fixmw_send_1cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_1cp_param_same.all)
```

```{r}
BOCD_fixmw_diff_1cp_param_same.all <- onlineCPD(fixmw_diff_1cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_1cp_param_same.all)
```

```{r}
BOCD_fixmw_ine_1cp_param_same.all <- onlineCPD(fixmw_ine_1cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_1cp_param_same.all)
```

```{r}
BOCD_fixmw_out_1cp_param_same.all <- onlineCPD(fixmw_out_1cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_1cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_1cp_param_same.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_1cp_param_same.all <- cpt.meanvar(fixmw_send_1cp_param_same.all, method="PELT")
summary(PELT_fixmw_send_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_send_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_send_1cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_1cp_param_same.all <- cpt.meanvar(fixmw_diff_1cp_param_same.all, method="PELT")
summary(PELT_fixmw_diff_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_diff_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_diff_1cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_1cp_param_same.all <- cpt.meanvar(fixmw_ine_1cp_param_same.all, method="PELT")
summary(PELT_fixmw_ine_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_ine_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_ine_1cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_fixmw_out_1cp_param_same.all <- cpt.meanvar(fixmw_out_1cp_param_same.all, method="PELT")
summary(PELT_fixmw_out_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_out_1cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_out_1cp_param_same.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_1cp_param_same.all <- cpt.meanvar(fixmw_send_1cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_send_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_send_1cp_param_same.all)
abline(v=BS_fixmw_send_1cp_param_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_1cp_param_same.all <- cpt.meanvar(fixmw_diff_1cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_diff_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_diff_1cp_param_same.all)
abline(v=BS_fixmw_diff_1cp_param_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_1cp_param_same.all <- cpt.meanvar(fixmw_ine_1cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_ine_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_ine_1cp_param_same.all)
abline(v=BS_fixmw_ine_1cp_param_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_1cp_param_same.all <- cpt.meanvar(fixmw_out_1cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_out_1cp_param_same.all)

# plot the location of CPs
plot(fixmw_out_1cp_param_same.all)
abline(v=BS_fixmw_out_1cp_param_same.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_send_1cp_param_same.all <- wbs(fixmw_send_1cp_param_same.all)
changepoints(WBS_fixmw_send_1cp_param_same.all)
plot(WBS_fixmw_send_1cp_param_same.all)
```

```{r}
WBS_fixmw_diff_1cp_param_same.all <- wbs(fixmw_diff_1cp_param_same.all)
changepoints(WBS_fixmw_diff_1cp_param_same.all)
plot(WBS_fixmw_diff_1cp_param_same.all)
```

```{r}
WBS_fixmw_ine_1cp_param_same.all <- wbs(fixmw_ine_1cp_param_same.all)
changepoints(WBS_fixmw_ine_1cp_param_same.all)
plot(WBS_fixmw_ine_1cp_param_same.all)
```

```{r}
WBS_fixmw_reci_1cp_param_same.all <- wbs(fixmw_reci_1cp_param_same.all)
changepoints(WBS_fixmw_reci_1cp_param_same.all)
plot(WBS_fixmw_reci_1cp_param_same.all)
```

**REH with 1 CP for all the statistics (at different locations)**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.1cp_diff.all <- list(
  "baseline" = -8.8,
  
  "z_send"= function(t) {
    # set the location of CP
    if(t < 21500) { # 4077
      0.18
    } else  {
      0.04}
  },
  
  "z_difference" = function(t) {
    # set the location of CP
    if(t < 31525) { # 5578
      -0.05
    } else  {
      -0.15}
  },
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 13000) { # 2791
      0.13
    } else  {
      0.06}
  },
  
  "outdegreeSender" = function(t) {
    # set the location of CP
    if(t < 38200) { # 6585
      0.13
    } else  {
      0.07}
  }
)

# create REH with 1 CP
reh_1cp_diff.all <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_1cp_diff.all[[i]] <- generate(formula = formula, param = param.1cp_diff.all, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.1cp_diff.all <- remstats(tie_effects = formula, edgelist = reh_1cp_diff.all) # also will be used for fitting REM
stat.1cp_diff.all <- out.1cp_diff.all[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of send
send_1cp_diff.all <- stat.1cp_diff.all[,,2]

# aggregate the statistics of each time point
send_1cp.agg.max_diff.all <- rowMaxs(send_1cp_diff.all)
plot(send_1cp.agg.max_diff.all, type = "lm")

send_1cp.agg.mean_diff.all <- rowMeans(send_1cp_diff.all)
plot(send_1cp.agg.mean_diff.all, type = "lm")
```

```{r}
# extract the statistics of diff
diff_1cp_diff.all <- stat.1cp_diff.all[,,3]

# aggregate the statistics of each time point
diff_1cp.agg.max_diff.all <- rowMaxs(diff_1cp_diff.all)
plot(diff_1cp.agg.max_diff.all, type = "lm")

diff_1cp.agg.mean_diff.all <- rowMeans(diff_1cp_diff.all)
plot(diff_1cp.agg.mean_diff.all, type = "lm")
```

```{r}
# extract the statistics of inertia
ine_1cp_diff.all <- stat.1cp_diff.all[,,4]

# aggregate the statistics of each time point
ine_1cp.agg.max_diff.all <- rowMaxs(ine_1cp_diff.all)
plot(ine_1cp.agg.max_diff.all, type = "lm")

ine_1cp.agg.mean_diff.all <- rowMeans(ine_1cp_diff.all)
plot(ine_1cp.agg.mean_diff.all, type = "lm")
```

```{r}
# extract the statistics of diff
reci_1cp_diff.all <- stat.1cp_diff.all[,,5]

# aggregate the statistics of each time point
reci_1cp.agg.max_diff.all <- rowMaxs(reci_1cp_diff.all)
plot(reci_1cp.agg.max_diff.all, type = "lm")

reci_1cp.agg.mean_diff.all <- rowMeans(reci_1cp_diff.all)
plot(reci_1cp.agg.mean_diff.all, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_send_1cp.agg.mean_diff.all <- onlineCPD(send_1cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_send_1cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_1cp.agg.mean_diff.all)

BOCD_send_1cp.agg.max_diff.all <- onlineCPD(send_1cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_1cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_1cp.agg.max_diff.all)
```

```{r}
BOCD_diff_1cp.agg.mean_diff.all <- onlineCPD(diff_1cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_diff_1cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_1cp.agg.mean_diff.all)

BOCD_diff_1cp.agg.max_diff.all <- onlineCPD(diff_1cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_1cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_1cp.agg.max_diff.all)
```

```{r}
BOCD_ine_1cp.agg.mean_diff.all <- onlineCPD(ine_1cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_ine_1cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.mean_diff.all)

BOCD_ine_1cp.agg.max_diff.all <- onlineCPD(ine_1cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.max_diff.all)
```

```{r}
BOCD_reci_1cp.agg.mean_diff.all <- onlineCPD(reci_1cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_reci_1cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_1cp.agg.mean_diff.all)

BOCD_reci_1cp.agg.max_diff.all <- onlineCPD(reci_1cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_1cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_1cp.agg.max_diff.all)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_1cp.agg.mean_diff.all <- cpt.var(send_1cp.agg.mean_diff.all, method="PELT")
summary(PELT_send_1cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(send_1cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_send_1cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_1cp.agg.mean_diff.all <- cpt.var(diff_1cp.agg.mean_diff.all, method="PELT")
summary(PELT_diff_1cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(diff_1cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_diff_1cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.mean_diff.all <- cpt.var(ine_1cp.agg.mean_diff.all, method="PELT")
summary(PELT_ine_1cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(ine_1cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_1cp.agg.mean_diff.all <- cpt.var(reci_1cp.agg.mean_diff.all, method="PELT")
summary(PELT_reci_1cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(reci_1cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_reci_1cp.agg.mean_diff.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_1cp.agg.max_diff.all <- cpt.var(send_1cp.agg.max_diff.all, method="PELT")
summary(PELT_send_1cp.agg.max_diff.all)

# plot the location of detected CPs
plot(send_1cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_send_1cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_1cp.agg.max_diff.all <- cpt.var(diff_1cp.agg.max_diff.all, method="PELT")
summary(PELT_diff_1cp.agg.max_diff.all)

# plot the location of detected CPs
plot(diff_1cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_diff_1cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.max_diff.all <- cpt.var(ine_1cp.agg.max_diff.all, method="PELT")
summary(PELT_ine_1cp.agg.max_diff.all)

# plot the location of detected CPs
plot(ine_1cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_1cp.agg.max_diff.all <- cpt.var(reci_1cp.agg.max_diff.all, method="PELT")
summary(PELT_reci_1cp.agg.max_diff.all)

# plot the location of detected CPs
plot(reci_1cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_reci_1cp.agg.max_diff.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_1cp.agg.mean_diff.all <- cpt.var(send_1cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_send_1cp.agg.mean_diff.all)

# plot the location of CPs
plot(send_1cp.agg.mean_diff.all)
abline(v=BS_send_1cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_1cp.agg.mean_diff.all <- cpt.var(diff_1cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_diff_1cp.agg.mean_diff.all)

# plot the location of CPs
plot(diff_1cp.agg.mean_diff.all)
abline(v=BS_diff_1cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.mean_diff.all <- cpt.var(ine_1cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_ine_1cp.agg.mean_diff.all)

# plot the location of CPs
plot(ine_1cp.agg.mean_diff.all)
abline(v=BS_ine_1cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_1cp.agg.mean_diff.all <- cpt.var(reci_1cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_reci_1cp.agg.mean_diff.all)

# plot the location of CPs
plot(reci_1cp.agg.mean_diff.all)
ablreci(v=BS_reci_1cp.agg.mean_diff.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_1cp.agg.max_diff.all <- cpt.var(send_1cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_send_1cp.agg.max_diff.all)

# plot the location of CPs
plot(send_1cp.agg.max_diff.all)
abline(v=BS_send_1cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_1cp.agg.max_diff.all <- cpt.var(diff_1cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_diff_1cp.agg.max_diff.all)

# plot the location of CPs
plot(diff_1cp.agg.max_diff.all)
abline(v=BS_diff_1cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.max_diff.all <- cpt.var(ine_1cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_ine_1cp.agg.max_diff.all)

# plot the location of CPs
plot(ine_1cp.agg.max_diff.all)
abline(v=BS_ine_1cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_1cp.agg.max_diff.all <- cpt.var(reci_1cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_reci_1cp.agg.max_diff.all)

# plot the location of CPs
plot(reci_1cp.agg.max_diff.all)
abline(v=BS_diff_1cp.agg.max_diff.all@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_send_1cp.agg.mean_diff.all <- wbs(send_1cp.agg.mean_diff.all)
changepoints(WBS_send_1cp.agg.mean_diff.all)
plot(WBS_send_1cp.agg.mean_diff.all)
```

```{r}
WBS_diff_1cp.agg.mean_diff.all <- wbs(diff_1cp.agg.mean_diff.all)
changepoints(WBS_diff_1cp.agg.mean_diff.all)
plot(WBS_diff_1cp.agg.mean_diff.all)
```

```{r}
WBS_ine_1cp.agg.mean_diff.all <- wbs(ine_1cp.agg.mean_diff.all)
changepoints(WBS_ine_1cp.agg.mean_diff.all)
plot(WBS_ine_1cp.agg.mean_diff.all)
```

```{r}
WBS_reci_1cp.agg.mean_diff.all <- wbs(reci_1cp.agg.mean_diff.all)
changepoints(WBS_reci_1cp.agg.mean_diff.all)
plot(WBS_reci_1cp.agg.mean_diff.all)
```

- Max
```{r}
WBS_send_1cp.agg.max_diff.all <- wbs(send_1cp.agg.max_diff.all)
changepoints(WBS_send_1cp.agg.max_diff.all)
plot(WBS_send_1cp.agg.max_diff.all)
```

```{r}
WBS_diff_1cp.agg.max_diff.all <- wbs(diff_1cp.agg.max_diff.all)
changepoints(WBS_diff_1cp.agg.max_diff.all)
plot(WBS_diff_1cp.agg.max_diff.all)
```

```{r}
WBS_ine_1cp.agg.max_diff.all <- wbs(ine_1cp.agg.max_diff.all)
changepoints(WBS_ine_1cp.agg.max_diff.all)
plot(WBS_ine_1cp.agg.max_diff.all)
```

```{r}
WBS_reci_1cp.agg.max_diff.all <- wbs(reci_1cp.agg.max_diff.all)
changepoints(WBS_reci_1cp.agg.max_diff.all)
plot(WBS_reci_1cp.agg.max_diff.all)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_send_1cp_diff.all <- max_mean_time(send_1cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_send_1cp_diff.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_diff_1cp_diff.all <- max_mean_time(diff_1cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_diff_1cp_diff.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_1cp_diff.all <- max_mean_time(ine_1cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_1cp_diff.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_reci_1cp_diff.all <- max_mean_time(reci_1cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_reci_1cp_diff.all) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_send_1cp.agg.top_diff.all <- onlineCPD(top_send_1cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_1cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_1cp.agg.top_diff.all)
```

```{r}
# test the CPs
BOCD_diff_1cp.agg.top_diff.all <- onlineCPD(top_diff_1cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_1cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_1cp.agg.top_diff.all)
```

```{r}
# test the CPs
BOCD_ine_1cp.agg.top_diff.all <- onlineCPD(top_ine_1cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_1cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_1cp.agg.top_diff.all)
```

```{r}
# test the CPs
BOCD_reci_1cp.agg.top_diff.all <- onlineCPD(top_reci_1cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_1cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_1cp.agg.top_diff.all)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_1cp.agg.top_diff.all <- cpt.var(top_send_1cp_diff.all, method="PELT")
summary(PELT_send_1cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_send_1cp_diff.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_1cp.agg.top_diff.all <- cpt.var(top_diff_1cp_diff.all, method="PELT")
summary(PELT_diff_1cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_diff_1cp_diff.all, type="point", col = "black")
abline(v=PELT_diff_1cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_1cp.agg.top_diff.all <- cpt.var(top_ine_1cp_diff.all, method="PELT")
summary(PELT_ine_1cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_ine_1cp_diff.all, type="point", col = "black")
abline(v=PELT_ine_1cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_1cp.agg.top_diff.all <- cpt.var(top_reci_1cp_diff.all, method="PELT")
summary(PELT_reci_1cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_reci_1cp_diff.all, type="point", col = "black")
abline(v=PELT_reci_1cp.agg.top_diff.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_1cp.agg.top_diff.all <- cpt.meanvar(top_send_1cp_diff.all, method = "BinSeg")
cpts(BS_send_1cp.agg.top_diff.all)

# plot the location of CPs
plot(top_send_1cp_diff.all)
abline(v=BS_send_1cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_1cp.agg.top_diff.all <- cpt.meanvar(top_diff_1cp_diff.all, method = "BinSeg")
cpts(BS_diff_1cp.agg.top_diff.all)

# plot the location of CPs
plot(top_diff_1cp_diff.all)
abline(v=BS_diff_1cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_1cp.agg.top_diff.all <- cpt.meanvar(top_ine_1cp_diff.all, method = "BinSeg")
cpts(BS_ine_1cp.agg.top_diff.all)

# plot the location of CPs
plot(top_ine_1cp_diff.all)
abline(v=BS_ine_1cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_1cp.agg.top_diff.all <- cpt.meanvar(top_reci_1cp_diff.all, method = "BinSeg")
cpts(BS_reci_1cp.agg.top_diff.all)

# plot the location of CPs
plot(top_reci_1cp_diff.all)
abline(v=BS_reci_1cp.agg.top_diff.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_send_1cp.agg.top <- wbs(top_send_1cp_diff.all)
changepoints(WBS_send_1cp.agg.top_diff.all)
plot(WBS_send_1cp.agg.top_diff.all)
```

```{r}
WBS_diff_1cp.agg.top <- wbs(top_diff_1cp_diff.all)
changepoints(WBS_diff_1cp.agg.top_diff.all)
plot(WBS_diff_1cp.agg.top_diff.all)
```

```{r}
WBS_ine_1cp.agg.top <- wbs(top_ine_1cp_diff.all)
changepoints(WBS_ine_1cp.agg.top_diff.all)
plot(WBS_ine_1cp.agg.top_diff.all)
```

```{r}
WBS_reci_1cp.agg.top <- wbs(top_reci_1cp_diff.all)
changepoints(WBS_reci_1cp.agg.top_diff.all)
plot(WBS_reci_1cp.agg.top_diff.all)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_1cp_diff.all <- reh_1cp_diff.all[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_1cp_diff.all, file = "REH_1CP_diff.all.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_1cp_diff.all <- ddwindows(edgelist = reh_1cp_diff.all, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_1cp_diff.all <- MWrem(windows = ddwin_1cp_diff.all$windows, edgelist = reh_1cp_diff.all, 
		stats = stat.1cp_diff.all, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_send_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["send.z"]]
}
plot(ddmw_send_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_diff_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_ine_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_reci_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_send_1cp_param_diff.all <- onlineCPD(ddmw_send_1cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_send_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_send_1cp_param_diff.all)
```

```{r}
BOCD_ddmw_diff_1cp_param_diff.all <- onlineCPD(ddmw_diff_1cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_diff_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_diff_1cp_param_diff.all)
```

```{r}
BOCD_ddmw_ine_1cp_param_diff.all <- onlineCPD(ddmw_ine_1cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_1cp_param_diff.all)
```

```{r}
BOCD_ddmw_reci_1cp_param_diff.all <- onlineCPD(ddmw_reci_1cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_reci_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_reci_1cp_param_diff.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_send_1cp_param_diff.all <- cpt.var(ddmw_send_1cp_param_diff.all, method="PELT")
summary(PELT_ddmw_send_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_send_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_send_1cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_ddmw_diff_1cp_param_diff.all <- cpt.var(ddmw_diff_1cp_param_diff.all, method="PELT")
summary(PELT_ddmw_diff_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_diff_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_diff_1cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_ddmw_ine_1cp_param_diff.all <- cpt.var(ddmw_ine_1cp_param_diff.all, method="PELT")
summary(PELT_ddmw_ine_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_ine_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_ine_1cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_ddmw_reci_1cp_param_diff.all <- cpt.var(ddmw_reci_1cp_param_diff.all, method="PELT")
summary(PELT_ddmw_reci_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_reci_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_reci_1cp_param_diff.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_send_1cp_param_diff.all <- cpt.var(ddmw_send_1cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_send_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_send_1cp_param_diff.all)
abline(v=BS_ddmw_send_1cp_param_diff.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_diff_1cp_param_diff.all <- cpt.var(ddmw_diff_1cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_diff_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_diff_1cp_param_diff.all)
abline(v=BS_ddmw_diff_1cp_param_diff.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_1cp_param_diff.all <- cpt.var(ddmw_ine_1cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_ine_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_ine_1cp_param_diff.all)
abline(v=BS_ddmw_ine_1cp_param_diff.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_reci_1cp_param_diff.all <- cpt.var(ddmw_reci_1cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_reci_1cp_param_diff.all)

# plot the location of CPs
plot(ddmw_reci_1cp_param_diff.all)
abline(v=BS_ddmw_reci_1cp_param_diff.all@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_send_1cp_param_diff.all <- wbs(ddmw_send_1cp_param_diff.all)
changepoints(WBS_ddmw_send_1cp_param_diff.all)
plot(WBS_ddmw_send_1cp_param_diff.all)
```

```{r}
WBS_ddmw_diff_1cp_param_diff.all <- wbs(ddmw_diff_1cp_param_diff.all)
changepoints(WBS_ddmw_diff_1cp_param_diff.all)
plot(WBS_ddmw_diff_1cp_param_diff.all)
```

```{r}
WBS_ddmw_ine_1cp_param_diff.all <- wbs(ddmw_ine_1cp_param_diff.all)
changepoints(WBS_ddmw_ine_1cp_param_diff.all)
plot(WBS_ddmw_ine_1cp_param_diff.all)
```

```{r}
WBS_ddmw_reci_1cp_param_diff.all <- wbs(ddmw_reci_1cp_param_diff.all)
changepoints(WBS_ddmw_reci_1cp_param_diff.all)
plot(WBS_ddmw_reci_1cp_param_diff.all)
```

*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_1cp_diff.all$time)

# specify the length of the window
windows_1cp_diff.all <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_1cp_diff.all <- REHdynamics::MWrem(windows_1cp_diff.all, edgelist = reh_1cp_diff.all, 
                                       stats = stat.1cp_diff.all,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_1cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_1cp_diff.all)) {
  fixmw_send_1cp_param_diff.all[i] <- model_fixwin_1cp_diff.all[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_1cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_1cp_diff.all)) {
  fixmw_diff_1cp_param_diff.all[i] <- model_fixwin_1cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_1cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_1cp_diff.all)) {
  fixmw_ine_1cp_param_diff.all[i] <- model_fixwin_1cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_1cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_1cp_diff.all)) {
  fixmw_out_1cp_param_diff.all[i] <- model_fixwin_1cp_diff.all[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_1cp_param_diff.all <- onlineCPD(fixmw_send_1cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_1cp_param_diff.all)
```

```{r}
BOCD_fixmw_diff_1cp_param_diff.all <- onlineCPD(fixmw_diff_1cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_1cp_param_diff.all)
```

```{r}
BOCD_fixmw_ine_1cp_param_diff.all <- onlineCPD(fixmw_ine_1cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_1cp_param_diff.all)
```

```{r}
BOCD_fixmw_out_1cp_param_diff.all <- onlineCPD(fixmw_out_1cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_1cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_1cp_param_diff.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_1cp_param_diff.all <- cpt.var(fixmw_send_1cp_param_diff.all, method="PELT")
summary(PELT_fixmw_send_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_send_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_send_1cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_1cp_param_diff.all <- cpt.var(fixmw_diff_1cp_param_diff.all, method="PELT")
summary(PELT_fixmw_diff_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_diff_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_diff_1cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_1cp_param_diff.all <- cpt.var(fixmw_ine_1cp_param_diff.all, method="PELT")
summary(PELT_fixmw_ine_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_ine_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_ine_1cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_fixmw_out_1cp_param_diff.all <- cpt.var(fixmw_out_1cp_param_diff.all, method="PELT")
summary(PELT_fixmw_out_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_out_1cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_out_1cp_param_diff.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_1cp_param_diff.all <- cpt.meanvar(fixmw_send_1cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_send_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_send_1cp_param_diff.all)
abline(v=BS_fixmw_send_1cp_param_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_1cp_param_diff.all <- cpt.meanvar(fixmw_diff_1cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_diff_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_diff_1cp_param_diff.all)
abline(v=BS_fixmw_diff_1cp_param_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_1cp_param_diff.all <- cpt.meanvar(fixmw_ine_1cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_ine_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_ine_1cp_param_diff.all)
abline(v=BS_fixmw_ine_1cp_param_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_1cp_param_diff.all <- cpt.meanvar(fixmw_out_1cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_out_1cp_param_diff.all)

# plot the location of CPs
plot(fixmw_out_1cp_param_diff.all)
abline(v=BS_fixmw_out_1cp_param_diff.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_send_1cp_param_diff.all <- wbs(fixmw_send_1cp_param_diff.all)
changepoints(WBS_fixmw_send_1cp_param_diff.all)
plot(WBS_fixmw_send_1cp_param_diff.all)
```

```{r}
WBS_fixmw_diff_1cp_param_diff.all <- wbs(fixmw_diff_1cp_param_diff.all)
changepoints(WBS_fixmw_diff_1cp_param_diff.all)
plot(WBS_fixmw_diff_1cp_param_diff.all)
```

```{r}
WBS_fixmw_ine_1cp_param_diff.all <- wbs(fixmw_ine_1cp_param_diff.all)
changepoints(WBS_fixmw_ine_1cp_param_diff.all)
plot(WBS_fixmw_ine_1cp_param_diff.all)
```

```{r}
WBS_fixmw_out_1cp_param_diff.all <- wbs(fixmw_out_1cp_param_diff.all)
changepoints(WBS_fixmw_out_1cp_param_diff.all)
plot(WBS_fixmw_out_1cp_param_diff.all)
```

**REH with 2 CPs for inertia, none for the rest**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.2cp <- list(
  "baseline" = -8.8,
  "z_send"= 0.12, 
  "z_difference" = -0.11,
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 16750) { #2574
      0.03
      } else
        
        if(t < 53900) { #7519
          0.12
          } else {0.18}
  },
  
  "outdegreeSender" = 0.12
)

# create REH with 1 CP
reh_2cp <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_2cp[[i]] <- generate(formula = formula, param = param.2cp, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.2cp <- remstats(tie_effects = formula, edgelist = reh_2cp) # also will be used for fitting REM
stat.2cp <- out.2cp[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of inertia
ine_2cp <- stat.2cp[,,4]

# aggregate the statistics of each time point
ine_2cp.agg.max <- rowMaxs(ine_2cp)
plot(ine_2cp.agg.max, type = "lm")

ine_2cp.agg.mean <- rowMeans(ine_2cp)
plot(ine_2cp.agg.mean, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ine_2cp.agg.mean <- onlineCPD(ine_2cp.agg.mean, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.mean[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.mean)

BOCD_ine_2cp.agg.max <- onlineCPD(ine_2cp.agg.max, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.max[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.max)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.mean <- cpt.var(ine_2cp.agg.mean, method="PELT")
summary(PELT_ine_2cp.agg.mean)

# plot the location of detected CPs
plot(ine_2cp.agg.mean, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.max <- cpt.var(ine_2cp.agg.max, method="PELT")
summary(PELT_ine_2cp.agg.max)

# plot the location of detected CPs
plot(ine_2cp.agg.max, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.max@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.mean <- cpt.meanvar(ine_2cp.agg.mean, method = "BinSeg")
cpts(BS_ine_2cp.agg.mean)

# plot the location of CPs
plot(ine_2cp.agg.mean)
abline(v=BS_ine_2cp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.max <- cpt.meanvar(ine_2cp.agg.max, method = "BinSeg")
cpts(BS_ine_2cp.agg.max)

# plot the location of CPs
plot(ine_2cp.agg.max)
abline(v=BS_ine_2cp.agg.max@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_ine_2cp.agg.mean <- wbs(ine_2cp.agg.mean)
changepoints(WBS_ine_2cp.agg.mean)
plot(WBS_ine_2cp.agg.mean)
```

- Max
```{r}
WBS_ine_2cp.agg.max <- wbs(ine_2cp.agg.max)
changepoints(WBS_ine_2cp.agg.max)
plot(WBS_ine_2cp.agg.max)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_2cp <- max_mean_time(ine_2cp, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_2cp) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_ine_2cp.agg.top <- onlineCPD(top_ine_2cp, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.top[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.top)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.top <- cpt.var(top_ine_2cp, method="PELT")
summary(PELT_ine_2cp.agg.top)

# plot the location of detected CPs
plot(top_ine_2cp, type="l", col = "black")
abline(v=PELT_ine_2cp.agg.top@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.top <- cpt.meanvar(top_ine_2cp, method = "BinSeg")
cpts(BS_ine_2cp.agg.top)

# plot the location of CPs
plot(top_ine_2cp)
abline(v=BS_ine_2cp.agg.top@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_ine_2cp.agg.top <- wbs(top_ine_2cp)
changepoints(WBS_ine_2cp.agg.top)
plot(WBS_ine_2cp.agg.top)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_2cp <- reh_2cp[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_2cp, file = "REH_2CP.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_2cp <- ddwindows(edgelist = reh_2cp, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_2cp <- MWrem(windows = ddwin_2cp$windows, edgelist = reh_2cp, 
		stats = stat.2cp, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_ine_2cp_param <- 1
for (i in 1:length(model_ddwin_2cp)) {
  ddmw_ine_2cp_param[i] <- model_ddwin_2cp[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_2cp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_ine_2cp_param <- onlineCPD(ddmw_ine_2cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_2cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_2cp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_ine_2cp_param <- cpt.var(ddmw_ine_2cp_param, method="PELT")
summary(PELT_ddmw_ine_2cp_param)

# plot the location of CPs
plot(ddmw_ine_2cp_param, type="l", col = "red")
abline(v=PELT_ddmw_ine_2cp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_2cp_param <- cpt.meanvar(ddmw_ine_2cp_param, method = "BinSeg")
cpts(BS_ddmw_ine_2cp_param)

# plot the location of CPs
plot(ddmw_ine_2cp_param)
abline(v=BS_ddmw_ine_2cp_param@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_ine_2cp_param <- wbs(ddmw_ine_2cp_param)
changepoints(WBS_ddmw_ine_2cp_param)
plot(WBS_ddmw_ine_2cp_param)
```


*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_2cp$time)

# specify the length of the window
windows_2cp <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_2cp <- REHdynamics::MWrem(windows_2cp, edgelist = reh_2cp, 
                                       stats = stat.2cp,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_2cp_param <- 1
for (i in 1:length(model_fixwin_2cp)) {
  fixmw_send_2cp_param[i] <- model_fixwin_2cp[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_2cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_2cp_param <- 1
for (i in 1:length(model_fixwin_2cp)) {
  fixmw_diff_2cp_param[i] <- model_fixwin_2cp[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_2cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_2cp_param <- 1
for (i in 1:length(model_fixwin_2cp)) {
  fixmw_ine_2cp_param[i] <- model_fixwin_2cp[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_2cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_2cp_param <- 1
for (i in 1:length(model_fixwin_2cp)) {
  fixmw_out_2cp_param[i] <- model_fixwin_2cp[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_2cp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_2cp_param <- onlineCPD(fixmw_send_2cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_2cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_2cp_param)
```

```{r}
BOCD_fixmw_diff_2cp_param <- onlineCPD(fixmw_diff_2cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_2cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_2cp_param)
```

```{r}
BOCD_fixmw_ine_2cp_param <- onlineCPD(fixmw_ine_2cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_2cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_2cp_param)
```

```{r}
BOCD_fixmw_out_2cp_param <- onlineCPD(fixmw_out_2cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_2cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_2cp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_2cp_param <- cpt.var(fixmw_send_2cp_param, method="PELT")
summary(PELT_fixmw_send_2cp_param)

# plot the location of CPs
plot(fixmw_send_2cp_param, type="l", col = "red")
abline(v=PELT_fixmw_send_2cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_2cp_param <- cpt.var(fixmw_diff_2cp_param, method="PELT")
summary(PELT_fixmw_diff_2cp_param)

# plot the location of CPs
plot(fixmw_diff_2cp_param, type="l", col = "red")
abline(v=PELT_fixmw_diff_2cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_2cp_param <- cpt.meanvar(fixmw_ine_2cp_param, method="PELT")
summary(PELT_fixmw_ine_2cp_param)

# plot the location of CPs
plot(fixmw_ine_2cp_param, type="l", col = "red")
abline(v=PELT_fixmw_ine_2cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_out_2cp_param <- cpt.var(fixmw_out_2cp_param, method="PELT")
summary(PELT_fixmw_out_2cp_param)

# plot the location of CPs
plot(fixmw_out_2cp_param, type="l", col = "red")
abline(v=PELT_fixmw_out_2cp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_2cp_param <- cpt.var(fixmw_send_2cp_param, method = "BinSeg")
cpts(BS_fixmw_send_2cp_param)

# plot the location of CPs
plot(fixmw_send_2cp_param)
abline(v=BS_fixmw_send_2cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_2cp_param <- cpt.var(fixmw_diff_2cp_param, method = "BinSeg")
cpts(BS_fixmw_diff_2cp_param)

# plot the location of CPs
plot(fixmw_diff_2cp_param)
abline(v=BS_fixmw_diff_2cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_2cp_param <- cpt.var(fixmw_ine_2cp_param, method = "BinSeg")
cpts(BS_fixmw_ine_2cp_param)

# plot the location of CPs
plot(fixmw_ine_2cp_param)
abline(v=BS_fixmw_ine_2cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_2cp_param <- cpt.var(fixmw_out_2cp_param, method = "BinSeg")
cpts(BS_fixmw_out_2cp_param)

# plot the location of CPs
plot(fixmw_out_2cp_param)
abline(v=BS_fixmw_out_2cp_param@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_ine_2cp_param <- wbs(fixmw_ine_2cp_param)
changepoints(WBS_fixmw_ine_2cp_param)
plot(WBS_fixmw_ine_2cp_param)
```

**REH with 2 CPs for all the statistics (at same location)**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.2cp_same.all <- list(
  "baseline" = -8.8,
  
  "z_send"= function(t) {
    # set the location of CP
    if(t < 16750) { #8366
      0.18
    } else
      
      if(t < 53900) { #7519
          0.04
          } else {0.17}
    },
  
  "z_difference" = function(t) {
    # set the location of CP
    if(t < 16750) { #8366
      -0.05
    } else
      
      if(t < 53900) { #7519
          -0.12
          } else {0.03}
    },
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 16750) { #2574
      0.02
      } else
        
        if(t < 53900) { #7519
          0.14
          } else {0.03}
    },
  
  "outdegreeSender" = function(t) {
    # set the location of CP
    if(t < 16750) { #8366
      0.02
      } else
        
        if(t < 53900) { #7519
          0.14
          } else {0.04}
    }
)

# create REH with 1 CP
reh_2cp_same.all <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_2cp_same.all[[i]] <- generate(formula = formula, param = param.2cp_same.all, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.2cp_same.all <- remstats(tie_effects = formula, edgelist = reh_2cp_same.all) # also will be used for fitting REM
stat.2cp_same.all <- out.2cp_same.all[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of send
send_2cp_same.all <- stat.2cp_same.all[,,2]

# aggregate the statistics of each time point
send_2cp.agg.max_same.all <- rowMaxs(send_2cp_same.all)
plot(send_2cp.agg.max_same.all, type = "lm")

send_2cp.agg.mean_same.all <- rowMeans(send_2cp_same.all)
plot(send_2cp.agg.mean_same.all, type = "lm")
```

```{r}
# extract the statistics of diff
diff_2cp_same.all <- stat.2cp_same.all[,,3]

# aggregate the statistics of each time point
diff_2cp.agg.max_same.all <- rowMaxs(diff_2cp_same.all)
plot(diff_2cp.agg.max_same.all, type = "lm")

diff_2cp.agg.mean_same.all <- rowMeans(diff_2cp_same.all)
plot(diff_2cp.agg.mean_same.all, type = "lm")
```

```{r}
# extract the statistics of inertia
ine_2cp_same.all <- stat.2cp_same.all[,,4]

# aggregate the statistics of each time point
ine_2cp.agg.max_same.all <- rowMaxs(ine_2cp_same.all)
plot(ine_2cp.agg.max_same.all, type = "lm")

ine_2cp.agg.mean_same.all <- rowMeans(ine_2cp_same.all)
plot(ine_2cp.agg.mean_same.all, type = "lm")
```

```{r}
# extract the statistics of diff
reci_2cp_same.all <- stat.2cp_same.all[,,5]

# aggregate the statistics of each time point
reci_2cp.agg.max_same.all <- rowMaxs(reci_2cp_same.all)
plot(reci_2cp.agg.max_same.all, type = "lm")

reci_2cp.agg.mean_same.all <- rowMeans(reci_2cp_same.all)
plot(reci_2cp.agg.mean_same.all, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_send_2cp.agg.mean_same.all <- onlineCPD(send_2cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_send_2cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_2cp.agg.mean_same.all)

BOCD_send_2cp.agg.max_same.all <- onlineCPD(send_2cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_2cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_2cp.agg.max_same.all)
```

```{r}
BOCD_diff_2cp.agg.mean_same.all <- onlineCPD(diff_2cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_diff_2cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_2cp.agg.mean_same.all)

BOCD_diff_2cp.agg.max_same.all <- onlineCPD(diff_2cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_2cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_2cp.agg.max_same.all)
```

```{r}
BOCD_ine_2cp.agg.mean_same.all <- onlineCPD(ine_2cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_ine_2cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.mean_same.all)

BOCD_ine_2cp.agg.max_same.all <- onlineCPD(ine_2cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.max_same.all)
```

```{r}
BOCD_reci_2cp.agg.mean_same.all <- onlineCPD(reci_2cp.agg.mean_same.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_reci_2cp.agg.mean_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_2cp.agg.mean_same.all)

BOCD_reci_2cp.agg.max_same.all <- onlineCPD(reci_2cp.agg.max_same.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_2cp.agg.max_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_2cp.agg.max_same.all)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_2cp.agg.mean_same.all <- cpt.var(send_2cp.agg.mean_same.all, method="PELT")
summary(PELT_send_2cp.agg.mean_same.all)

# plot the location of detected CPs
plot(send_2cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_send_2cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_2cp.agg.mean_same.all <- cpt.var(diff_2cp.agg.mean_same.all, method="PELT")
summary(PELT_diff_2cp.agg.mean_same.all)

# plot the location of detected CPs
plot(diff_2cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_diff_2cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.mean_same.all <- cpt.var(ine_2cp.agg.mean_same.all, method="PELT")
summary(PELT_ine_2cp.agg.mean_same.all)

# plot the location of detected CPs
plot(ine_2cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_2cp.agg.mean_same.all <- cpt.var(reci_2cp.agg.mean_same.all, method="PELT")
summary(PELT_reci_2cp.agg.mean_same.all)

# plot the location of detected CPs
plot(reci_2cp.agg.mean_same.all, type="point", col = "black")
abline(v=PELT_reci_2cp.agg.mean_same.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_2cp.agg.max_same.all <- cpt.var(send_2cp.agg.max_same.all, method="PELT")
summary(PELT_send_2cp.agg.max_same.all)

# plot the location of detected CPs
plot(send_2cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_send_2cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_2cp.agg.max_same.all <- cpt.var(diff_2cp.agg.max_same.all, method="PELT")
summary(PELT_diff_2cp.agg.max_same.all)

# plot the location of detected CPs
plot(diff_2cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_diff_2cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.max_same.all <- cpt.var(ine_2cp.agg.max_same.all, method="PELT")
summary(PELT_ine_2cp.agg.max_same.all)

# plot the location of detected CPs
plot(ine_2cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_2cp.agg.max_same.all <- cpt.var(reci_2cp.agg.max_same.all, method="PELT")
summary(PELT_reci_2cp.agg.max_same.all)

# plot the location of detected CPs
plot(reci_2cp.agg.max_same.all, type="point", col = "black")
abline(v=PELT_reci_2cp.agg.max_same.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_2cp.agg.mean_same.all <- cpt.var(send_2cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_send_2cp.agg.mean_same.all)

# plot the location of CPs
plot(send_2cp.agg.mean_same.all)
abline(v=BS_send_2cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_2cp.agg.mean_same.all <- cpt.var(diff_2cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_diff_2cp.agg.mean_same.all)

# plot the location of CPs
plot(diff_2cp.agg.mean_same.all)
abline(v=BS_diff_2cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.mean_same.all <- cpt.var(ine_2cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_ine_2cp.agg.mean_same.all)

# plot the location of CPs
plot(ine_2cp.agg.mean_same.all)
abline(v=BS_ine_2cp.agg.mean_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_2cp.agg.mean_same.all <- cpt.var(reci_2cp.agg.mean_same.all, method = "BinSeg")
cpts(BS_reci_2cp.agg.mean_same.all)

# plot the location of CPs
plot(reci_2cp.agg.mean_same.all)
ablreci(v=BS_reci_2cp.agg.mean_same.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_2cp.agg.max_same.all <- cpt.var(send_2cp.agg.max_same.all, method = "BinSeg")
cpts(BS_send_2cp.agg.max_same.all)

# plot the location of CPs
plot(send_2cp.agg.max_same.all)
abline(v=BS_send_2cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_2cp.agg.max_same.all <- cpt.var(diff_2cp.agg.max_same.all, method = "BinSeg")
cpts(BS_diff_2cp.agg.max_same.all)

# plot the location of CPs
plot(diff_2cp.agg.max_same.all)
abline(v=BS_diff_2cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.max_same.all <- cpt.var(ine_2cp.agg.max_same.all, method = "BinSeg")
cpts(BS_ine_2cp.agg.max_same.all)

# plot the location of CPs
plot(ine_2cp.agg.max_same.all)
abline(v=BS_ine_2cp.agg.max_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_2cp.agg.max_same.all <- cpt.var(reci_2cp.agg.max_same.all, method = "BinSeg")
cpts(BS_reci_2cp.agg.max_same.all)

# plot the location of CPs
plot(reci_2cp.agg.max_same.all)
abline(v=BS_diff_2cp.agg.max_same.all@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_send_2cp.agg.mean_same.all <- wbs(send_2cp.agg.mean_same.all)
changepoints(WBS_send_2cp.agg.mean_same.all)
plot(WBS_send_2cp.agg.mean_same.all)
```

```{r}
WBS_diff_2cp.agg.mean_same.all <- wbs(diff_2cp.agg.mean_same.all)
changepoints(WBS_diff_2cp.agg.mean_same.all)
plot(WBS_diff_2cp.agg.mean_same.all)
```

```{r}
WBS_ine_2cp.agg.mean_same.all <- wbs(ine_2cp.agg.mean_same.all)
changepoints(WBS_ine_2cp.agg.mean_same.all)
plot(WBS_ine_2cp.agg.mean_same.all)
```

```{r}
WBS_reci_2cp.agg.mean_same.all <- wbs(reci_2cp.agg.mean_same.all)
changepoints(WBS_reci_2cp.agg.mean_same.all)
plot(WBS_reci_2cp.agg.mean_same.all)
```

- Max
```{r}
WBS_send_2cp.agg.max_same.all <- wbs(send_2cp.agg.max_same.all)
changepoints(WBS_send_2cp.agg.max_same.all)
plot(WBS_send_2cp.agg.max_same.all)
```

```{r}
WBS_diff_2cp.agg.max_same.all <- wbs(diff_2cp.agg.max_same.all)
changepoints(WBS_diff_2cp.agg.max_same.all)
plot(WBS_diff_2cp.agg.max_same.all)
```

```{r}
WBS_ine_2cp.agg.max_same.all <- wbs(ine_2cp.agg.max_same.all)
changepoints(WBS_ine_2cp.agg.max_same.all)
plot(WBS_ine_2cp.agg.max_same.all)
```

```{r}
WBS_reci_2cp.agg.max_same.all <- wbs(reci_2cp.agg.max_same.all)
changepoints(WBS_reci_2cp.agg.max_same.all)
plot(WBS_reci_2cp.agg.max_same.all)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_send_2cp_same.all <- max_mean_time(send_2cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_send_2cp_same.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_diff_2cp_same.all <- max_mean_time(diff_2cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_diff_2cp_same.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_2cp_same.all <- max_mean_time(ine_2cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_2cp_same.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_reci_2cp_same.all <- max_mean_time(reci_2cp_same.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_reci_2cp_same.all) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_send_2cp.agg.top_same.all <- onlineCPD(top_send_2cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_2cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_2cp.agg.top_same.all)
```

```{r}
# test the CPs
BOCD_diff_2cp.agg.top_same.all <- onlineCPD(top_diff_2cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_2cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_2cp.agg.top_same.all)
```

```{r}
# test the CPs
BOCD_ine_2cp.agg.top_same.all <- onlineCPD(top_ine_2cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.top_same.all)
```

```{r}
# test the CPs
BOCD_reci_2cp.agg.top_same.all <- onlineCPD(top_reci_2cp_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_2cp.agg.top_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_2cp.agg.top_same.all)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_2cp.agg.top_same.all <- cpt.var(top_send_2cp_same.all, method="PELT")
summary(PELT_send_2cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_send_2cp_same.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_2cp.agg.top_same.all <- cpt.var(top_diff_2cp_same.all, method="PELT")
summary(PELT_diff_2cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_diff_2cp_same.all, type="point", col = "black")
abline(v=PELT_diff_2cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.top_same.all <- cpt.var(top_ine_2cp_same.all, method="PELT")
summary(PELT_ine_2cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_ine_2cp_same.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_2cp.agg.top_same.all <- cpt.var(top_reci_2cp_same.all, method="PELT")
summary(PELT_reci_2cp.agg.top_same.all)

# plot the location of detected CPs
plot(top_reci_2cp_same.all, type="point", col = "black")
abline(v=PELT_reci_2cp.agg.top_same.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_2cp.agg.top_same.all <- cpt.meanvar(top_send_2cp_same.all, method = "BinSeg")
cpts(BS_send_2cp.agg.top_same.all)

# plot the location of CPs
plot(top_send_2cp_same.all)
abline(v=BS_send_2cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_2cp.agg.top_same.all <- cpt.meanvar(top_diff_2cp_same.all, method = "BinSeg")
cpts(BS_diff_2cp.agg.top_same.all)

# plot the location of CPs
plot(top_diff_2cp_same.all)
abline(v=BS_diff_2cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.top_same.all <- cpt.meanvar(top_ine_2cp_same.all, method = "BinSeg")
cpts(BS_ine_2cp.agg.top_same.all)

# plot the location of CPs
plot(top_ine_2cp_same.all)
abline(v=BS_ine_2cp.agg.top_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_2cp.agg.top_same.all <- cpt.meanvar(top_reci_2cp_same.all, method = "BinSeg")
cpts(BS_reci_2cp.agg.top_same.all)

# plot the location of CPs
plot(top_reci_2cp_same.all)
abline(v=BS_reci_2cp.agg.top_same.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_send_2cp.agg.top <- wbs(top_send_2cp_same.all)
changepoints(WBS_send_2cp.agg.top_same.all)
plot(WBS_send_2cp.agg.top_same.all)
```

```{r}
WBS_diff_2cp.agg.top <- wbs(top_diff_2cp_same.all)
changepoints(WBS_diff_2cp.agg.top_same.all)
plot(WBS_diff_2cp.agg.top_same.all)
```

```{r}
WBS_ine_2cp.agg.top <- wbs(top_ine_2cp_same.all)
changepoints(WBS_ine_2cp.agg.top_same.all)
plot(WBS_ine_2cp.agg.top_same.all)
```

```{r}
WBS_reci_2cp.agg.top <- wbs(top_reci_2cp_same.all)
changepoints(WBS_reci_2cp.agg.top_same.all)
plot(WBS_reci_2cp.agg.top_same.all)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*
```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_2cp_same.all <- reh_2cp_same.all[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_2cp_same.all, file = "REH_2CP_same.all.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_2cp_same.all <- ddwindows(edgelist = reh_2cp_same.all, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_2cp_same.all <- MWrem(windows = ddwin_2cp_same.all$windows, edgelist = reh_2cp_same.all, 
		stats = stat.2cp_same.all, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_2cp_param_same.all <- 1
for (i in 1:length(model_ddwin_2cp_same.all)) {
  ddmw_send_2cp_param_same.all[i] <- model_ddwin_2cp_same.all[[i]][["coefficients"]][["send.z"]]
}
plot(ddmw_send_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_2cp_param_same.all <- 1
for (i in 1:length(model_ddwin_2cp_same.all)) {
  ddmw_diff_2cp_param_same.all[i] <- model_ddwin_2cp_same.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_2cp_param_same.all <- 1
for (i in 1:length(model_ddwin_2cp_same.all)) {
  ddmw_ine_2cp_param_same.all[i] <- model_ddwin_2cp_same.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_2cp_param_same.all <- 1
for (i in 1:length(model_ddwin_2cp_same.all)) {
  ddmw_reci_2cp_param_same.all[i] <- model_ddwin_2cp_same.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_send_2cp_param_same.all <- onlineCPD(ddmw_send_2cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_send_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_send_2cp_param_same.all)
```

```{r}
BOCD_ddmw_diff_2cp_param_same.all <- onlineCPD(ddmw_diff_2cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_diff_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_diff_2cp_param_same.all)
```

```{r}
BOCD_ddmw_ine_2cp_param_same.all <- onlineCPD(ddmw_ine_2cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_2cp_param_same.all)
```

```{r}
BOCD_ddmw_reci_2cp_param_same.all <- onlineCPD(ddmw_reci_2cp_param_same.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_reci_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_reci_2cp_param_same.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_send_2cp_param_same.all <- cpt.var(ddmw_send_2cp_param_same.all, method="PELT")
summary(PELT_ddmw_send_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_send_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_send_2cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_ddmw_diff_2cp_param_same.all <- cpt.var(ddmw_diff_2cp_param_same.all, method="PELT")
summary(PELT_ddmw_diff_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_diff_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_diff_2cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_ddmw_ine_2cp_param_same.all <- cpt.var(ddmw_ine_2cp_param_same.all, method="PELT")
summary(PELT_ddmw_ine_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_ine_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_ine_2cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_ddmw_reci_2cp_param_same.all <- cpt.var(ddmw_reci_2cp_param_same.all, method="PELT")
summary(PELT_ddmw_reci_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_reci_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_ddmw_reci_2cp_param_same.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_send_2cp_param_same.all <- cpt.var(ddmw_send_2cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_send_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_send_2cp_param_same.all)
abline(v=BS_ddmw_send_2cp_param_same.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_diff_2cp_param_same.all <- cpt.var(ddmw_diff_2cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_diff_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_diff_2cp_param_same.all)
abline(v=BS_ddmw_diff_2cp_param_same.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_2cp_param_same.all <- cpt.var(ddmw_ine_2cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_ine_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_ine_2cp_param_same.all)
abline(v=BS_ddmw_ine_2cp_param_same.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_reci_2cp_param_same.all <- cpt.var(ddmw_reci_2cp_param_same.all, method = "BinSeg")
cpts(BS_ddmw_reci_2cp_param_same.all)

# plot the location of CPs
plot(ddmw_reci_2cp_param_same.all)
abline(v=BS_ddmw_reci_2cp_param_same.all@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_send_2cp_param_same.all <- wbs(ddmw_send_2cp_param_same.all)
changepoints(WBS_ddmw_send_2cp_param_same.all)
plot(WBS_ddmw_send_2cp_param_same.all)
```

```{r}
WBS_ddmw_diff_2cp_param_same.all <- wbs(ddmw_diff_2cp_param_same.all)
changepoints(WBS_ddmw_diff_2cp_param_same.all)
plot(WBS_ddmw_diff_2cp_param_same.all)
```

```{r}
WBS_ddmw_ine_2cp_param_same.all <- wbs(ddmw_ine_2cp_param_same.all)
changepoints(WBS_ddmw_ine_2cp_param_same.all)
plot(WBS_ddmw_ine_2cp_param_same.all)
```

```{r}
WBS_ddmw_reci_2cp_param_same.all <- wbs(ddmw_reci_2cp_param_same.all)
changepoints(WBS_ddmw_reci_2cp_param_same.all)
plot(WBS_ddmw_reci_2cp_param_same.all)
```

*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_2cp_same.all$time)

# specify the length of the window
windows_2cp_same.all <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_2cp_same.all <- REHdynamics::MWrem(windows_2cp_same.all, edgelist = reh_2cp_same.all, 
                                       stats = stat.2cp_same.all,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_2cp_param_same.all <- 1
for (i in 1:length(model_fixwin_2cp_same.all)) {
  fixmw_send_2cp_param_same.all[i] <- model_fixwin_2cp_same.all[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_2cp_param_same.all <- 1
for (i in 1:length(model_fixwin_2cp_same.all)) {
  fixmw_diff_2cp_param_same.all[i] <- model_fixwin_2cp_same.all[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_2cp_param_same.all <- 1
for (i in 1:length(model_fixwin_2cp_same.all)) {
  fixmw_ine_2cp_param_same.all[i] <- model_fixwin_2cp_same.all[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_2cp_param_same.all <- 1
for (i in 1:length(model_fixwin_2cp_same.all)) {
  fixmw_out_2cp_param_same.all[i] <- model_fixwin_2cp_same.all[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_2cp_param_same.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_2cp_param_same.all <- onlineCPD(fixmw_send_2cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_2cp_param_same.all)
```

```{r}
BOCD_fixmw_diff_2cp_param_same.all <- onlineCPD(fixmw_diff_2cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_2cp_param_same.all)
```

```{r}
BOCD_fixmw_ine_2cp_param_same.all <- onlineCPD(fixmw_ine_2cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_2cp_param_same.all)
```

```{r}
BOCD_fixmw_out_2cp_param_same.all <- onlineCPD(fixmw_out_2cp_param_same.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_2cp_param_same.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_2cp_param_same.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_2cp_param_same.all <- cpt.meanvar(fixmw_send_2cp_param_same.all, method="PELT")
summary(PELT_fixmw_send_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_send_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_send_2cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_2cp_param_same.all <- cpt.meanvar(fixmw_diff_2cp_param_same.all, method="PELT")
summary(PELT_fixmw_diff_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_diff_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_diff_2cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_2cp_param_same.all <- cpt.meanvar(fixmw_ine_2cp_param_same.all, method="PELT")
summary(PELT_fixmw_ine_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_ine_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_ine_2cp_param_same.all@cpts[], col="black")
```

```{r}
PELT_fixmw_out_2cp_param_same.all <- cpt.meanvar(fixmw_out_2cp_param_same.all, method="PELT")
summary(PELT_fixmw_out_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_out_2cp_param_same.all, type="l", col = "red")
abline(v=PELT_fixmw_out_2cp_param_same.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_2cp_param_same.all <- cpt.meanvar(fixmw_send_2cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_send_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_send_2cp_param_same.all)
abline(v=BS_fixmw_send_2cp_param_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_2cp_param_same.all <- cpt.meanvar(fixmw_diff_2cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_diff_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_diff_2cp_param_same.all)
abline(v=BS_fixmw_diff_2cp_param_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_2cp_param_same.all <- cpt.meanvar(fixmw_ine_2cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_ine_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_ine_2cp_param_same.all)
abline(v=BS_fixmw_ine_2cp_param_same.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_2cp_param_same.all <- cpt.meanvar(fixmw_out_2cp_param_same.all, method = "BinSeg")
cpts(BS_fixmw_out_2cp_param_same.all)

# plot the location of CPs
plot(fixmw_out_2cp_param_same.all)
abline(v=BS_fixmw_out_2cp_param_same.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_send_2cp_param_same.all <- wbs(fixmw_send_2cp_param_same.all)
changepoints(WBS_fixmw_send_2cp_param_same.all)
plot(WBS_fixmw_send_2cp_param_same.all)
```

```{r}
WBS_fixmw_diff_2cp_param_same.all <- wbs(fixmw_diff_2cp_param_same.all)
changepoints(WBS_fixmw_diff_2cp_param_same.all)
plot(WBS_fixmw_diff_2cp_param_same.all)
```

```{r}
WBS_fixmw_ine_2cp_param_same.all <- wbs(fixmw_ine_2cp_param_same.all)
changepoints(WBS_fixmw_ine_2cp_param_same.all)
plot(WBS_fixmw_ine_2cp_param_same.all)
```

```{r}
WBS_fixmw_reci_2cp_param_same.all <- wbs(fixmw_reci_2cp_param_same.all)
changepoints(WBS_fixmw_reci_2cp_param_same.all)
plot(WBS_fixmw_reci_2cp_param_same.all)
```




































































**REH with 2 CPs for all the statistics (at different locations)**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.2cp_diff.all <- list(
  "baseline" = -8.8,
  
  "z_send"= function(t) {
    # set the location of CP
    if(t < 21880) { #8366
      0.18
    } else
      
      if(t < 44260) { #7519
          0.01
          } else {0.18}
    },
  
  "z_difference" = function(t) {
    # set the location of CP
    if(t < 18250) { #8366
      -0.04
    } else
      
      if(t < 40710) { #7519
          -0.12
          } else {0.01}
    },
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 16750) { #2574
      0.05
      } else
        
        if(t < 53900) { #7519
          0.14
          } else {0.03}
    },
  
  "outdegreeSender" = function(t) {
    # set the location of CP
    if(t < 36370) { #8366
      0.035
      } else
        
        if(t < 64000) { #7519
          0.15
          } else {0.04}
    }
)

# create REH with 1 CP
reh_2cp_diff.all <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_2cp_diff.all[[i]] <- generate(formula = formula, param = param.2cp_diff.all, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.2cp_diff.all <- remstats(tie_effects = formula, edgelist = reh_2cp_diff.all) # also will be used for fitting REM
stat.2cp_diff.all <- out.2cp_diff.all[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of send
send_2cp_diff.all <- stat.2cp_diff.all[,,2]

# aggregate the statistics of each time point
send_2cp.agg.max_diff.all <- rowMaxs(send_2cp_diff.all)
plot(send_2cp.agg.max_diff.all, type = "lm")

send_2cp.agg.mean_diff.all <- rowMeans(send_2cp_diff.all)
plot(send_2cp.agg.mean_diff.all, type = "lm")
```

```{r}
# extract the statistics of diff
diff_2cp_diff.all <- stat.2cp_diff.all[,,3]

# aggregate the statistics of each time point
diff_2cp.agg.max_diff.all <- rowMaxs(diff_2cp_diff.all)
plot(diff_2cp.agg.max_diff.all, type = "lm")

diff_2cp.agg.mean_diff.all <- rowMeans(diff_2cp_diff.all)
plot(diff_2cp.agg.mean_diff.all, type = "lm")
```

```{r}
# extract the statistics of inertia
ine_2cp_diff.all <- stat.2cp_diff.all[,,4]

# aggregate the statistics of each time point
ine_2cp.agg.max_diff.all <- rowMaxs(ine_2cp_diff.all)
plot(ine_2cp.agg.max_diff.all, type = "lm")

ine_2cp.agg.mean_diff.all <- rowMeans(ine_2cp_diff.all)
plot(ine_2cp.agg.mean_diff.all, type = "lm")
```

```{r}
# extract the statistics of diff
reci_2cp_diff.all <- stat.2cp_diff.all[,,5]

# aggregate the statistics of each time point
reci_2cp.agg.max_diff.all <- rowMaxs(reci_2cp_diff.all)
plot(reci_2cp.agg.max_diff.all, type = "lm")

reci_2cp.agg.mean_diff.all <- rowMeans(reci_2cp_diff.all)
plot(reci_2cp.agg.mean_diff.all, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_send_2cp.agg.mean_diff.all <- onlineCPD(send_2cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_send_2cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_2cp.agg.mean_diff.all)

BOCD_send_2cp.agg.max_diff.all <- onlineCPD(send_2cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_2cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_2cp.agg.max_diff.all)
```

```{r}
BOCD_diff_2cp.agg.mean_diff.all <- onlineCPD(diff_2cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_diff_2cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_2cp.agg.mean_diff.all)

BOCD_diff_2cp.agg.max_diff.all <- onlineCPD(diff_2cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_2cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_2cp.agg.max_diff.all)
```

```{r}
BOCD_ine_2cp.agg.mean_diff.all <- onlineCPD(ine_2cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_ine_2cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.mean_diff.all)

BOCD_ine_2cp.agg.max_diff.all <- onlineCPD(ine_2cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.max_diff.all)
```

```{r}
BOCD_reci_2cp.agg.mean_diff.all <- onlineCPD(reci_2cp.agg.mean_diff.all, 
                                            getR = T, optionalOutputs = T, 
                                            truncRlim = 10^-4)
BOCD_reci_2cp.agg.mean_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_2cp.agg.mean_diff.all)

BOCD_reci_2cp.agg.max_diff.all <- onlineCPD(reci_2cp.agg.max_diff.all, getR = T, 
                                           optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_2cp.agg.max_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_2cp.agg.max_diff.all)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_2cp.agg.mean_diff.all <- cpt.var(send_2cp.agg.mean_diff.all, method="PELT")
summary(PELT_send_2cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(send_2cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_send_2cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_2cp.agg.mean_diff.all <- cpt.var(diff_2cp.agg.mean_diff.all, method="PELT")
summary(PELT_diff_2cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(diff_2cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_diff_2cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.mean_diff.all <- cpt.var(ine_2cp.agg.mean_diff.all, method="PELT")
summary(PELT_ine_2cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(ine_2cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_2cp.agg.mean_diff.all <- cpt.var(reci_2cp.agg.mean_diff.all, method="PELT")
summary(PELT_reci_2cp.agg.mean_diff.all)

# plot the location of detected CPs
plot(reci_2cp.agg.mean_diff.all, type="point", col = "black")
abline(v=PELT_reci_2cp.agg.mean_diff.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_2cp.agg.max_diff.all <- cpt.var(send_2cp.agg.max_diff.all, method="PELT")
summary(PELT_send_2cp.agg.max_diff.all)

# plot the location of detected CPs
plot(send_2cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_send_2cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_2cp.agg.max_diff.all <- cpt.var(diff_2cp.agg.max_diff.all, method="PELT")
summary(PELT_diff_2cp.agg.max_diff.all)

# plot the location of detected CPs
plot(diff_2cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_diff_2cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.max_diff.all <- cpt.var(ine_2cp.agg.max_diff.all, method="PELT")
summary(PELT_ine_2cp.agg.max_diff.all)

# plot the location of detected CPs
plot(ine_2cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_2cp.agg.max_diff.all <- cpt.var(reci_2cp.agg.max_diff.all, method="PELT")
summary(PELT_reci_2cp.agg.max_diff.all)

# plot the location of detected CPs
plot(reci_2cp.agg.max_diff.all, type="point", col = "black")
abline(v=PELT_reci_2cp.agg.max_diff.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_2cp.agg.mean_diff.all <- cpt.var(send_2cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_send_2cp.agg.mean_diff.all)

# plot the location of CPs
plot(send_2cp.agg.mean_diff.all)
abline(v=BS_send_2cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_2cp.agg.mean_diff.all <- cpt.var(diff_2cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_diff_2cp.agg.mean_diff.all)

# plot the location of CPs
plot(diff_2cp.agg.mean_diff.all)
abline(v=BS_diff_2cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.mean_diff.all <- cpt.var(ine_2cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_ine_2cp.agg.mean_diff.all)

# plot the location of CPs
plot(ine_2cp.agg.mean_diff.all)
abline(v=BS_ine_2cp.agg.mean_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_2cp.agg.mean_diff.all <- cpt.var(reci_2cp.agg.mean_diff.all, method = "BinSeg")
cpts(BS_reci_2cp.agg.mean_diff.all)

# plot the location of CPs
plot(reci_2cp.agg.mean_diff.all)
ablreci(v=BS_reci_2cp.agg.mean_diff.all@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_2cp.agg.max_diff.all <- cpt.var(send_2cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_send_2cp.agg.max_diff.all)

# plot the location of CPs
plot(send_2cp.agg.max_diff.all)
abline(v=BS_send_2cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_2cp.agg.max_diff.all <- cpt.var(diff_2cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_diff_2cp.agg.max_diff.all)

# plot the location of CPs
plot(diff_2cp.agg.max_diff.all)
abline(v=BS_diff_2cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.max_diff.all <- cpt.var(ine_2cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_ine_2cp.agg.max_diff.all)

# plot the location of CPs
plot(ine_2cp.agg.max_diff.all)
abline(v=BS_ine_2cp.agg.max_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_2cp.agg.max_diff.all <- cpt.var(reci_2cp.agg.max_diff.all, method = "BinSeg")
cpts(BS_reci_2cp.agg.max_diff.all)

# plot the location of CPs
plot(reci_2cp.agg.max_diff.all)
abline(v=BS_diff_2cp.agg.max_diff.all@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_send_2cp.agg.mean_diff.all <- wbs(send_2cp.agg.mean_diff.all)
changepoints(WBS_send_2cp.agg.mean_diff.all)
plot(WBS_send_2cp.agg.mean_diff.all)
```

```{r}
WBS_diff_2cp.agg.mean_diff.all <- wbs(diff_2cp.agg.mean_diff.all)
changepoints(WBS_diff_2cp.agg.mean_diff.all)
plot(WBS_diff_2cp.agg.mean_diff.all)
```

```{r}
WBS_ine_2cp.agg.mean_diff.all <- wbs(ine_2cp.agg.mean_diff.all)
changepoints(WBS_ine_2cp.agg.mean_diff.all)
plot(WBS_ine_2cp.agg.mean_diff.all)
```

```{r}
WBS_reci_2cp.agg.mean_diff.all <- wbs(reci_2cp.agg.mean_diff.all)
changepoints(WBS_reci_2cp.agg.mean_diff.all)
plot(WBS_reci_2cp.agg.mean_diff.all)
```

- Max
```{r}
WBS_send_2cp.agg.max_diff.all <- wbs(send_2cp.agg.max_diff.all)
changepoints(WBS_send_2cp.agg.max_diff.all)
plot(WBS_send_2cp.agg.max_diff.all)
```

```{r}
WBS_diff_2cp.agg.max_diff.all <- wbs(diff_2cp.agg.max_diff.all)
changepoints(WBS_diff_2cp.agg.max_diff.all)
plot(WBS_diff_2cp.agg.max_diff.all)
```

```{r}
WBS_ine_2cp.agg.max_diff.all <- wbs(ine_2cp.agg.max_diff.all)
changepoints(WBS_ine_2cp.agg.max_diff.all)
plot(WBS_ine_2cp.agg.max_diff.all)
```

```{r}
WBS_reci_2cp.agg.max_diff.all <- wbs(reci_2cp.agg.max_diff.all)
changepoints(WBS_reci_2cp.agg.max_diff.all)
plot(WBS_reci_2cp.agg.max_diff.all)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_send_2cp_diff.all <- max_mean_time(send_2cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_send_2cp_diff.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_diff_2cp_diff.all <- max_mean_time(diff_2cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_diff_2cp_diff.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_2cp_diff.all <- max_mean_time(ine_2cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_2cp_diff.all) # plot it out
```

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_reci_2cp_diff.all <- max_mean_time(reci_2cp_diff.all, percent = 0.05)$means_max.values_each_timepoint
plot(top_reci_2cp_diff.all) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_send_2cp.agg.top_diff.all <- onlineCPD(top_send_2cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_send_2cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_send_2cp.agg.top_diff.all)
```

```{r}
# test the CPs
BOCD_diff_2cp.agg.top_diff.all <- onlineCPD(top_diff_2cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_diff_2cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_diff_2cp.agg.top_diff.all)
```

```{r}
# test the CPs
BOCD_ine_2cp.agg.top_diff.all <- onlineCPD(top_ine_2cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_2cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_2cp.agg.top_diff.all)
```

```{r}
# test the CPs
BOCD_reci_2cp.agg.top_diff.all <- onlineCPD(top_reci_2cp_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_reci_2cp.agg.top_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_reci_2cp.agg.top_diff.all)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_send_2cp.agg.top_diff.all <- cpt.var(top_send_2cp_diff.all, method="PELT")
summary(PELT_send_2cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_send_2cp_diff.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_diff_2cp.agg.top_diff.all <- cpt.var(top_diff_2cp_diff.all, method="PELT")
summary(PELT_diff_2cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_diff_2cp_diff.all, type="point", col = "black")
abline(v=PELT_diff_2cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_2cp.agg.top_diff.all <- cpt.var(top_ine_2cp_diff.all, method="PELT")
summary(PELT_ine_2cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_ine_2cp_diff.all, type="point", col = "black")
abline(v=PELT_ine_2cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_reci_2cp.agg.top_diff.all <- cpt.var(top_reci_2cp_diff.all, method="PELT")
summary(PELT_reci_2cp.agg.top_diff.all)

# plot the location of detected CPs
plot(top_reci_2cp_diff.all, type="point", col = "black")
abline(v=PELT_reci_2cp.agg.top_diff.all@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_send_2cp.agg.top_diff.all <- cpt.meanvar(top_send_2cp_diff.all, method = "BinSeg")
cpts(BS_send_2cp.agg.top_diff.all)

# plot the location of CPs
plot(top_send_2cp_diff.all)
abline(v=BS_send_2cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_diff_2cp.agg.top_diff.all <- cpt.meanvar(top_diff_2cp_diff.all, method = "BinSeg")
cpts(BS_diff_2cp.agg.top_diff.all)

# plot the location of CPs
plot(top_diff_2cp_diff.all)
abline(v=BS_diff_2cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_2cp.agg.top_diff.all <- cpt.meanvar(top_ine_2cp_diff.all, method = "BinSeg")
cpts(BS_ine_2cp.agg.top_diff.all)

# plot the location of CPs
plot(top_ine_2cp_diff.all)
abline(v=BS_ine_2cp.agg.top_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_reci_2cp.agg.top_diff.all <- cpt.meanvar(top_reci_2cp_diff.all, method = "BinSeg")
cpts(BS_reci_2cp.agg.top_diff.all)

# plot the location of CPs
plot(top_reci_2cp_diff.all)
abline(v=BS_reci_2cp.agg.top_diff.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_send_2cp.agg.top <- wbs(top_send_2cp_diff.all)
changepoints(WBS_send_2cp.agg.top_diff.all)
plot(WBS_send_2cp.agg.top_diff.all)
```

```{r}
WBS_diff_2cp.agg.top <- wbs(top_diff_2cp_diff.all)
changepoints(WBS_diff_2cp.agg.top_diff.all)
plot(WBS_diff_2cp.agg.top_diff.all)
```

```{r}
WBS_ine_2cp.agg.top <- wbs(top_ine_2cp_diff.all)
changepoints(WBS_ine_2cp.agg.top_diff.all)
plot(WBS_ine_2cp.agg.top_diff.all)
```

```{r}
WBS_reci_2cp.agg.top <- wbs(top_reci_2cp_diff.all)
changepoints(WBS_reci_2cp.agg.top_diff.all)
plot(WBS_reci_2cp.agg.top_diff.all)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_2cp_diff.all <- reh_2cp_diff.all[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_2cp_diff.all, file = "REH_2CP_diff.all.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_2cp_diff.all <- ddwindows(edgelist = reh_2cp_diff.all, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_2cp_diff.all <- MWrem(windows = ddwin_2cp_diff.all$windows, edgelist = reh_2cp_diff.all, 
		stats = stat.2cp_diff.all, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_2cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_2cp_diff.all)) {
  ddmw_send_2cp_param_diff.all[i] <- model_ddwin_2cp_diff.all[[i]][["coefficients"]][["send.z"]]
}
plot(ddmw_send_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_2cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_2cp_diff.all)) {
  ddmw_diff_2cp_param_diff.all[i] <- model_ddwin_2cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_2cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_2cp_diff.all)) {
  ddmw_ine_2cp_param_diff.all[i] <- model_ddwin_2cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_2cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_2cp_diff.all)) {
  ddmw_reci_2cp_param_diff.all[i] <- model_ddwin_2cp_diff.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_send_2cp_param_diff.all <- onlineCPD(ddmw_send_2cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_send_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_send_2cp_param_diff.all)
```

```{r}
BOCD_ddmw_diff_2cp_param_diff.all <- onlineCPD(ddmw_diff_2cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_diff_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_diff_2cp_param_diff.all)
```

```{r}
BOCD_ddmw_ine_2cp_param_diff.all <- onlineCPD(ddmw_ine_2cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_2cp_param_diff.all)
```

```{r}
BOCD_ddmw_reci_2cp_param_diff.all <- onlineCPD(ddmw_reci_2cp_param_diff.all, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_reci_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_reci_2cp_param_diff.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_send_2cp_param_diff.all <- cpt.var(ddmw_send_2cp_param_diff.all, method="PELT")
summary(PELT_ddmw_send_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_send_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_send_2cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_ddmw_diff_2cp_param_diff.all <- cpt.var(ddmw_diff_2cp_param_diff.all, method="PELT")
summary(PELT_ddmw_diff_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_diff_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_diff_2cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_ddmw_ine_2cp_param_diff.all <- cpt.var(ddmw_ine_2cp_param_diff.all, method="PELT")
summary(PELT_ddmw_ine_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_ine_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_ine_2cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_ddmw_reci_2cp_param_diff.all <- cpt.var(ddmw_reci_2cp_param_diff.all, method="PELT")
summary(PELT_ddmw_reci_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_reci_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_ddmw_reci_2cp_param_diff.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_send_2cp_param_diff.all <- cpt.var(ddmw_send_2cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_send_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_send_2cp_param_diff.all)
abline(v=BS_ddmw_send_2cp_param_diff.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_diff_2cp_param_diff.all <- cpt.var(ddmw_diff_2cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_diff_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_diff_2cp_param_diff.all)
abline(v=BS_ddmw_diff_2cp_param_diff.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_2cp_param_diff.all <- cpt.var(ddmw_ine_2cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_ine_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_ine_2cp_param_diff.all)
abline(v=BS_ddmw_ine_2cp_param_diff.all@cpts[], col="black")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_reci_2cp_param_diff.all <- cpt.var(ddmw_reci_2cp_param_diff.all, method = "BinSeg")
cpts(BS_ddmw_reci_2cp_param_diff.all)

# plot the location of CPs
plot(ddmw_reci_2cp_param_diff.all)
abline(v=BS_ddmw_reci_2cp_param_diff.all@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_send_2cp_param_diff.all <- wbs(ddmw_send_2cp_param_diff.all)
changepoints(WBS_ddmw_send_2cp_param_diff.all)
plot(WBS_ddmw_send_2cp_param_diff.all)
```

```{r}
WBS_ddmw_diff_2cp_param_diff.all <- wbs(ddmw_diff_2cp_param_diff.all)
changepoints(WBS_ddmw_diff_2cp_param_diff.all)
plot(WBS_ddmw_diff_2cp_param_diff.all)
```

```{r}
WBS_ddmw_ine_2cp_param_diff.all <- wbs(ddmw_ine_2cp_param_diff.all)
changepoints(WBS_ddmw_ine_2cp_param_diff.all)
plot(WBS_ddmw_ine_2cp_param_diff.all)
```

```{r}
WBS_ddmw_reci_2cp_param_diff.all <- wbs(ddmw_reci_2cp_param_diff.all)
changepoints(WBS_ddmw_reci_2cp_param_diff.all)
plot(WBS_ddmw_reci_2cp_param_diff.all)
```

*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_2cp_diff.all$time)

# specify the length of the window
windows_2cp_diff.all <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_2cp_diff.all <- REHdynamics::MWrem(windows_2cp_diff.all, edgelist = reh_2cp_diff.all, 
                                       stats = stat.2cp_diff.all,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_2cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_2cp_diff.all)) {
  fixmw_send_2cp_param_diff.all[i] <- model_fixwin_2cp_diff.all[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_2cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_2cp_diff.all)) {
  fixmw_diff_2cp_param_diff.all[i] <- model_fixwin_2cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_2cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_2cp_diff.all)) {
  fixmw_ine_2cp_param_diff.all[i] <- model_fixwin_2cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_2cp_param_diff.all <- 1
for (i in 1:length(model_fixwin_2cp_diff.all)) {
  fixmw_out_2cp_param_diff.all[i] <- model_fixwin_2cp_diff.all[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_2cp_param_diff.all, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_2cp_param_diff.all <- onlineCPD(fixmw_send_2cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_2cp_param_diff.all)
```

```{r}
BOCD_fixmw_diff_2cp_param_diff.all <- onlineCPD(fixmw_diff_2cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_2cp_param_diff.all)
```

```{r}
BOCD_fixmw_ine_2cp_param_diff.all <- onlineCPD(fixmw_ine_2cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_2cp_param_diff.all)
```

```{r}
BOCD_fixmw_out_2cp_param_diff.all <- onlineCPD(fixmw_out_2cp_param_diff.all, 
                                               getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_2cp_param_diff.all[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_2cp_param_diff.all)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_2cp_param_diff.all <- cpt.meanvar(fixmw_send_2cp_param_diff.all, method="PELT")
summary(PELT_fixmw_send_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_send_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_send_2cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_2cp_param_diff.all <- cpt.var(fixmw_diff_2cp_param_diff.all, method="PELT")
summary(PELT_fixmw_diff_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_diff_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_diff_2cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_2cp_param_diff.all <- cpt.var(fixmw_ine_2cp_param_diff.all, method="PELT")
summary(PELT_fixmw_ine_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_ine_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_ine_2cp_param_diff.all@cpts[], col="black")
```

```{r}
PELT_fixmw_out_2cp_param_diff.all <- cpt.var(fixmw_out_2cp_param_diff.all, method="PELT")
summary(PELT_fixmw_out_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_out_2cp_param_diff.all, type="l", col = "red")
abline(v=PELT_fixmw_out_2cp_param_diff.all@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_2cp_param_diff.all <- cpt.meanvar(fixmw_send_2cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_send_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_send_2cp_param_diff.all)
abline(v=BS_fixmw_send_2cp_param_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_2cp_param_diff.all <- cpt.meanvar(fixmw_diff_2cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_diff_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_diff_2cp_param_diff.all)
abline(v=BS_fixmw_diff_2cp_param_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_2cp_param_diff.all <- cpt.meanvar(fixmw_ine_2cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_ine_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_ine_2cp_param_diff.all)
abline(v=BS_fixmw_ine_2cp_param_diff.all@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_2cp_param_diff.all <- cpt.meanvar(fixmw_out_2cp_param_diff.all, method = "BinSeg")
cpts(BS_fixmw_out_2cp_param_diff.all)

# plot the location of CPs
plot(fixmw_out_2cp_param_diff.all)
abline(v=BS_fixmw_out_2cp_param_diff.all@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_send_2cp_param_diff.all <- wbs(fixmw_send_2cp_param_diff.all)
changepoints(WBS_fixmw_send_2cp_param_diff.all)
plot(WBS_fixmw_send_2cp_param_diff.all)
```

```{r}
WBS_fixmw_diff_2cp_param_diff.all <- wbs(fixmw_diff_2cp_param_diff.all)
changepoints(WBS_fixmw_diff_2cp_param_diff.all)
plot(WBS_fixmw_diff_2cp_param_diff.all)
```

```{r}
WBS_fixmw_ine_2cp_param_diff.all <- wbs(fixmw_ine_2cp_param_diff.all)
changepoints(WBS_fixmw_ine_2cp_param_diff.all)
plot(WBS_fixmw_ine_2cp_param_diff.all)
```

```{r}
WBS_fixmw_out_2cp_param_diff.all <- wbs(fixmw_out_2cp_param_diff.all)
changepoints(WBS_fixmw_out_2cp_param_diff.all)
plot(WBS_fixmw_out_2cp_param_diff.all)
```





































































**REH with 3 CPs for inertia, none for the rest**

```{r}
set.seed(9252568)
# REH with only inertia statistics
#formula <- ~ 1 + remstats::inertia(scaling = "std")

# set up the covariates
#covar <- data.frame(id = 1:15, time = 0, z = rnorm(n = 15))

# set up the value of parameters
param.3cp <- list(
  "baseline" = -8.8,
  "z_send"= 0.1, 
  "z_difference" = -0.1,
  
  "inertia" = function(t) {
    # set the location of CP
    if(t < 16750) { #2574
      0.14
      } else 
      
      if(t < 38200) { #5365
        0.06
        } else 
        
        if(t < 53900) { #7519
          0.13
          } else {0.06}
  },
  
  "outdegreeSender" = 0.12
)

# create REH with 1 CP
reh_3cp <- list()

rep <- 1 # replication times (number of datasets you wanna get)

for (i in 1: rep){
  reh_3cp[[i]] <- generate(formula = formula, param = param.3cp, M = 10000, covar = covar)
  print(i)
}
```

*Plot the Statistics out*
```{r}
# compute the statistics
out.3cp <- remstats(tie_effects = formula, edgelist = reh_3cp) # also will be used for fitting REM
stat.3cp <- out.3cp[["statistics"]] # extract the statistics from the list
```

```{r}
# extract the statistics of inertia
ine_3cp <- stat.3cp[,,4]

# aggregate the statistics of each time point
ine_3cp.agg.max <- rowMaxs(ine_3cp)
plot(ine_3cp.agg.max, type = "lm")

ine_3cp.agg.mean <- rowMeans(ine_3cp)
plot(ine_3cp.agg.mean, type = "lm")
```

*Test CPs of the aggregated statistics (mean and max)*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ine_3cp.agg.mean <- onlineCPD(ine_3cp.agg.mean, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_3cp.agg.mean[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_3cp.agg.mean)

BOCD_ine_3cp.agg.max <- onlineCPD(ine_3cp.agg.max, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_3cp.agg.max[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_3cp.agg.max)
```

2. PELT: Exact CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_3cp.agg.mean <- cpt.var(ine_3cp.agg.mean, method="PELT")
summary(PELT_ine_3cp.agg.mean)

# plot the location of detected CPs
plot(ine_3cp.agg.mean, type="point", col = "black")
abline(v=PELT_ine_3cp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_3cp.agg.max <- cpt.var(ine_3cp.agg.max, method="PELT")
summary(PELT_ine_3cp.agg.max)

# plot the location of detected CPs
plot(ine_3cp.agg.max, type="point", col = "black")
abline(v=PELT_ine_3cp.agg.max@cpts[], col="red")
```

3. BS: approximate CPs Detection Method

- Mean
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_3cp.agg.mean <- cpt.meanvar(ine_3cp.agg.mean, method = "BinSeg")
cpts(BS_ine_3cp.agg.mean)

# plot the location of CPs
plot(ine_3cp.agg.mean)
abline(v=BS_ine_3cp.agg.mean@cpts[], col="red")
```

- Max
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_3cp.agg.max <- cpt.meanvar(ine_3cp.agg.max, method = "BinSeg")
cpts(BS_ine_3cp.agg.max)

# plot the location of CPs
plot(ine_3cp.agg.max)
abline(v=BS_ine_3cp.agg.max@cpts[], col="red")
```

4. Wild BS

- Mean
```{r}
WBS_ine_3cp.agg.mean <- wbs(ine_3cp.agg.mean)
changepoints(WBS_ine_3cp.agg.mean)
plot(WBS_ine_3cp.agg.mean)
```

- Max
```{r}
WBS_ine_3cp.agg.max <- wbs(ine_3cp.agg.max)
changepoints(WBS_ine_3cp.agg.max)
plot(WBS_ine_3cp.agg.max)
```

*Test CPs of the aggregated statistics (top 5% of maximum statistics by timepoints)*

```{r}
# compute the mean of top 5% of maximum statistics by timepoints
top_ine_3cp <- max_mean_time(ine_3cp, percent = 0.05)$means_max.values_each_timepoint
plot(top_ine_3cp) # plot it out
```

1. BOCD: Exact CPs Detection Method
```{r}
# test the CPs
BOCD_ine_3cp.agg.top <- onlineCPD(top_ine_3cp, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ine_3cp.agg.top[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ine_3cp.agg.top)
```

2. PELT: Exact CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
PELT_ine_3cp.agg.top <- cpt.var(top_ine_3cp, method="PELT")
summary(PELT_ine_3cp.agg.top)

# plot the location of detected CPs
plot(top_ine_3cp, type="l", col = "black")
abline(v=PELT_ine_3cp.agg.top@cpts[], col="red")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ine_3cp.agg.top <- cpt.meanvar(top_ine_3cp, method = "BinSeg")
cpts(BS_ine_3cp.agg.top)

# plot the location of CPs
plot(top_ine_3cp)
abline(v=BS_ine_3cp.agg.top@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_ine_3cp.agg.top <- wbs(top_ine_3cp)
changepoints(WBS_ine_3cp.agg.top)
plot(WBS_ine_3cp.agg.top)
```

*Fit the Data-Driven MW REM on the REH with 1 CP*

```{r}
# extract the synthetic data with 1 CP (data frmae)
reh_3cp <- reh_3cp[[1]]
```

```{r}
# Save the created REH
saveRDS(object = reh_3cp, file = "REH_3CP.RDS")
```

1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin_3cp <- ddwindows(edgelist = reh_3cp, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_3cp <- MWrem(windows = ddwin_3cp$windows, edgelist = reh_3cp, 
		stats = stat.3cp, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_ine_3cp_param <- 1
for (i in 1:length(model_ddwin_3cp)) {
  ddmw_ine_3cp_param[i] <- model_ddwin_3cp[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_3cp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the DDMW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_ddmw_ine_3cp_param <- onlineCPD(ddmw_ine_3cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_ddmw_ine_3cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_ddmw_ine_3cp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_ddmw_ine_3cp_param <- cpt.var(ddmw_ine_3cp_param, method="PELT")
summary(PELT_ddmw_ine_3cp_param)

# plot the location of CPs
plot(ddmw_ine_3cp_param, type="l", col = "red")
abline(v=PELT_ddmw_ine_3cp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_ddmw_ine_3cp_param <- cpt.meanvar(ddmw_ine_3cp_param, method = "BinSeg")
cpts(BS_ddmw_ine_3cp_param)

# plot the location of CPs
plot(ddmw_ine_3cp_param)
abline(v=BS_ddmw_ine_3cp_param@cpts[], col="black")
```

4. Wild BS
```{r}
WBS_ddmw_ine_3cp_param <- wbs(ddmw_ine_3cp_param)
changepoints(WBS_ddmw_ine_3cp_param)
plot(WBS_ddmw_ine_3cp_param)
```


*Fit the Fixed MW REM on the REH with One CP*

1. Step 1: Decide the length of the window, and fit it into REM
```{r}
# maximum time point of the REH
tau <- max(reh_3cp$time)

# specify the length of the window
windows_3cp <- REHdynamics::createwindows(1500, tau)

# fit to the REM model
model_fixwin_3cp <- REHdynamics::MWrem(windows_3cp, edgelist = reh_3cp, 
                                       stats = stat.3cp,
                                       actors = covar$id, directed = TRUE, 
                                       method = "MLE", model = "tie", ncores = 2)
```

2. Step 2: Extract the parameters by windows and plot them out
```{r}
# extract the parameters
fixmw_send_3cp_param <- 1
for (i in 1:length(model_fixwin_3cp)) {
  fixmw_send_3cp_param[i] <- model_fixwin_3cp[[i]][["coefficients"]][["send.z"]]
}
plot(fixmw_send_3cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_diff_3cp_param <- 1
for (i in 1:length(model_fixwin_3cp)) {
  fixmw_diff_3cp_param[i] <- model_fixwin_3cp[[i]][["coefficients"]][["difference.z"]]
}
plot(fixmw_diff_3cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_ine_3cp_param <- 1
for (i in 1:length(model_fixwin_3cp)) {
  fixmw_ine_3cp_param[i] <- model_fixwin_3cp[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_3cp_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_3cp_param <- 1
for (i in 1:length(model_fixwin_3cp)) {
  fixmw_out_3cp_param[i] <- model_fixwin_3cp[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_3cp_param, type = "lm") # plot the movement of parameter
```

*Test CPs of the Fixed MW parameters*

1. BOCD: Exact CPs Detection Method
```{r}
BOCD_fixmw_send_3cp_param <- onlineCPD(fixmw_send_3cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_send_3cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_send_3cp_param)
```

```{r}
BOCD_fixmw_diff_3cp_param <- onlineCPD(fixmw_diff_3cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_diff_3cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_diff_3cp_param)
```

```{r}
BOCD_fixmw_ine_3cp_param <- onlineCPD(fixmw_ine_3cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_ine_3cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_ine_3cp_param)
```

```{r}
BOCD_fixmw_out_3cp_param <- onlineCPD(fixmw_out_3cp_param, getR = T, optionalOutputs = T, truncRlim = 10^-4)
BOCD_fixmw_out_3cp_param[["changepoint_lists"]][["maxCPs"]][[1]]
plot(BOCD_fixmw_out_3cp_param)
```

2. PELT: Exact CPs Detection Method
```{r}
PELT_fixmw_send_3cp_param <- cpt.var(fixmw_send_3cp_param, method="PELT")
summary(PELT_fixmw_send_3cp_param)

# plot the location of CPs
plot(fixmw_send_3cp_param, type="l", col = "red")
abline(v=PELT_fixmw_send_3cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_diff_3cp_param <- cpt.var(fixmw_diff_3cp_param, method="PELT")
summary(PELT_fixmw_diff_3cp_param)

# plot the location of CPs
plot(fixmw_diff_3cp_param, type="l", col = "red")
abline(v=PELT_fixmw_diff_3cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_ine_3cp_param <- cpt.var(fixmw_ine_3cp_param, method="PELT")
summary(PELT_fixmw_ine_3cp_param)

# plot the location of CPs
plot(fixmw_ine_3cp_param, type="l", col = "red")
abline(v=PELT_fixmw_ine_3cp_param@cpts[], col="black")
```

```{r}
PELT_fixmw_out_3cp_param <- cpt.var(fixmw_out_3cp_param, method="PELT")
summary(PELT_fixmw_out_3cp_param)

# plot the location of CPs
plot(fixmw_out_3cp_param, type="l", col = "red")
abline(v=PELT_fixmw_out_3cp_param@cpts[], col="black")
```

3. BS: approximate CPs Detection Method
```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_send_3cp_param <- cpt.var(fixmw_send_3cp_param, method = "BinSeg")
cpts(BS_fixmw_send_3cp_param)

# plot the location of CPs
plot(fixmw_send_3cp_param)
abline(v=BS_fixmw_send_3cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_diff_3cp_param <- cpt.var(fixmw_diff_3cp_param, method = "BinSeg")
cpts(BS_fixmw_diff_3cp_param)

# plot the location of CPs
plot(fixmw_diff_3cp_param)
abline(v=BS_fixmw_diff_3cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_ine_3cp_param <- cpt.var(fixmw_ine_3cp_param, method = "BinSeg")
cpts(BS_fixmw_ine_3cp_param)

# plot the location of CPs
plot(fixmw_ine_3cp_param)
abline(v=BS_fixmw_ine_3cp_param@cpts[], col="red")
```

```{r}
# cpt.meanvar -> find changes in both mean and variance for data
BS_fixmw_out_3cp_param <- cpt.var(fixmw_out_3cp_param, method = "BinSeg")
cpts(BS_fixmw_out_3cp_param)

# plot the location of CPs
plot(fixmw_out_3cp_param)
abline(v=BS_fixmw_out_3cp_param@cpts[], col="red")
```

4. Wild BS
```{r}
WBS_fixmw_ine_3cp_param <- wbs(fixmw_ine_3cp_param)
changepoints(WBS_fixmw_ine_3cp_param)
plot(WBS_fixmw_ine_3cp_param)
```


