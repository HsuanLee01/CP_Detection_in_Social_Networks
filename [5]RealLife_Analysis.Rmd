---
title: "Real-Life Data Analysis"
author: "Hsuan Lee"
output: pdf_document
---

```{r}
library(remstats) # the formula for REH
library(relevent) # fit REH to REM
library(REHdynamics) # fit the moving window REM
library(ocp) # package for BOCD
library(changepoint) # package for PELT, BS
set.seed(9252568)
```

# Load the data

```{r}
# Load data using load():
load("RealLife_Data/Merged_ALL_parts_Apollo.rdata")

# change the name of dataset, only leave time and actors infomation
Apollo.13 <- Merged_ALL_parts_Apollo[, -c(4,5)]

# change the names of columns
colnames(Apollo.13) <- c("time", "actor1", "actor2")
```

# Fit the REM

## Step 1: Assign the formula that indicates which effects shoould contain in the model
```{r}
formula <- ~ 1 + 
  remstats::inertia(scaling = "std") +
  remstats::outdegreeSender(scaling= "std") +
  remstats::reciprocity(scaling = "std") +
  remstats::totaldegreeSender(scaling = "std") +
  remstats::psABBA(consider_type = FALSE) +
  remstats::psABXA(consider_type = FALSE) +
  remstats::psABBY(consider_type = FALSE)

covar <- data.frame(id = 1:19, time = 0)
```

## Step 2: Compute the statistics
```{r}
out <- remstats(tie_effects = formula, edgelist = Apollo.13, actors = 19)
stat <- out[["statistics"]] # extract the statistics from the list
```

## Step 3: Fit the windows on the REH

Compute the optimal lengths of the windows (data-driven MW) -> *Problemtic*
```{r}
# obtain data-driven window widths
#ddwin <- ddwindows(edgelist = Apollo.13, tie_effects = formula, mintime = 1000, 
#                   covar = covar)
```

Save the DDMW, as it takes long time to run (15 hours) -> *Problemtic*
```{r}
#saveRDS(object = ddwin, file = "Apollo.13_ddwin.RDS")
```

Read the DDMW file -> *Problemtic*
```{r}
ddmw <- readRDS("Apollo.13_ddwin.RDS")
```

Fit the REM by windows -> *Problemtic*
```{r}
# fits a moving window relational event model
model_ddwin <- MWrem(windows = ddmw$windows, edgelist = Apollo.13, 
		                 stats = stat, actors = covar$id, directed = TRUE)
```

-----------------
Fit the fix MWREM
```{r}
# changepoint 201321 second

# maximum time point of each iteration of REH
tau <- max(Apollo.13$time)

# specify the length of the window
windows <- REHdynamics::createwindows(1000, tau, overlap = 2/3)

# fit to the REM model
model_fixwin <- REHdynamics::MWrem(windows, edgelist = Apollo.13, 
                                   stats = stat,
                                   actors = covar$id, directed = TRUE, 
                                   method = "MLE", model = "tie", ncores = 2)
```

Extract the window given parameters
```{r}
# extract the parameters
fixmw_ine_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_ine_param[i] <- model_fixwin[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_out_param[i] <- model_fixwin[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_rec_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_rec_param[i] <- model_fixwin[[i]][["coefficients"]][["reciprocity"]]
}
plot(fixmw_rec_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_totSend_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_totSend_param[i] <- model_fixwin[[i]][["coefficients"]][["totaldegreeSender"]]
}
plot(fixmw_totSend_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_psABBA_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_psABBA_param[i] <- model_fixwin[[i]][["coefficients"]][["psABBA"]]
}
plot(fixmw_psABBA_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_psABXA_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_psABXA_param[i] <- model_fixwin[[i]][["coefficients"]][["psABXA"]]
}
plot(fixmw_psABXA_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_psABBY_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_psABBY_param[i] <- model_fixwin[[i]][["coefficients"]][["psABBY"]]
}
plot(fixmw_psABBY_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

Operate chnagepoint detection methods to detect the chagepoint

- PELT

```{r}
PELT_fixmw_ine <- cpt.meanvar(fixmw_ine_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_ine@cpts[-length(PELT_fixmw_ine@cpts)] + 593

```

```{r}
PELT_fixmw_out <- cpt.meanvar(fixmw_out_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_out@cpts[-length(PELT_fixmw_out@cpts)] + 593
```

```{r}
PELT_fixmw_rec <- cpt.meanvar(fixmw_rec_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_rec@cpts[-length(PELT_fixmw_rec@cpts)] + 593
```

```{r}
PELT_fixmw_totSend <- cpt.meanvar(fixmw_totSend_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_totSend@cpts[-length(PELT_fixmw_totSend@cpts)] + 593
```

```{r}
PELT_fixmw_psABBA <- cpt.meanvar(fixmw_psABBA_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_psABBA@cpts[-length(PELT_fixmw_psABBA@cpts)] + 593
```

```{r}
PELT_fixmw_psABXA <- cpt.meanvar(fixmw_psABXA_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_psABXA@cpts[-length(PELT_fixmw_psABXA@cpts)] + 593
```

```{r}
PELT_fixmw_psABBY <- cpt.meanvar(fixmw_psABBY_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_psABBY@cpts[-length(PELT_fixmw_psABBY@cpts)] + 593
```

- BOCPD

```{r}
BOCD_fixmw_ine_param <- onlineCPD(fixmw_ine_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_ine <- BOCD_fixmw_ine_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_ine <- locat_BOCD_ine[-1])

plot(BOCD_fixmw_ine_param)
```

```{r}
BOCD_fixmw_out_param <- onlineCPD(fixmw_out_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_out <- BOCD_fixmw_out_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_out <- locat_BOCD_out[-1])

plot(BOCD_fixmw_out_param)
```

```{r}
BOCD_fixmw_rec_param <- onlineCPD(fixmw_rec_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_rec <- BOCD_fixmw_rec_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_rec <- locat_BOCD_rec[-1])

plot(BOCD_fixmw_rec_param)
```

```{r}
BOCD_fixmw_totSend_param <- onlineCPD(fixmw_totSend_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_totSend <- BOCD_fixmw_totSend_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_totSend <- locat_BOCD_totSend[-1])

plot(BOCD_fixmw_totSend_param)
```

```{r}
BOCD_fixmw_psABBA_param <- onlineCPD(fixmw_psABBA_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_psABBA <- BOCD_fixmw_psABBA_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_psABBA <- locat_BOCD_psABBA[-1])

plot(BOCD_fixmw_psABBA_param)
```

```{r}
BOCD_fixmw_psABXA_param <- onlineCPD(fixmw_psABXA_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_psABXA <- BOCD_fixmw_psABXA_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_psABXA <- locat_BOCD_psABXA[-1])

plot(BOCD_fixmw_psABXA_param)
```

```{r}
BOCD_fixmw_psABBY_param <- onlineCPD(fixmw_psABBY_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_psABBY <- BOCD_fixmw_psABBY_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_psABBY <- locat_BOCD_psABBY[-1])

plot(BOCD_fixmw_psABBY_param)
```
