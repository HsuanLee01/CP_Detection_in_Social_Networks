---
title: "Untitled"
author: "Hsuan Lee"
output: pdf_document
---

```{r}
library(remstats) # the formula for REH
library(relevent) # fit REH to REM
library(REHdynamics)
set.seed(9252568)
```

```{r}
Apollo.13 <- readRDS(file = "RealLife_Data/PartOfApollo_13.RDS")

colnames(Apollo.13) <- c("time", "actor1", "actor2")

Apollo.13$actor1[Apollo.13$actor1 == 17] <- 14
Apollo.13$actor1[Apollo.13$actor1 == 18] <- 15
Apollo.13$actor1[Apollo.13$actor1 == 19] <- 16

Apollo.13$actor2[Apollo.13$actor2 == 17] <- 14
Apollo.13$actor2[Apollo.13$actor2 == 18] <- 15
Apollo.13$actor2[Apollo.13$actor2 == 19] <- 16

sort(unique(Apollo.13$actor1))
sort(unique(Apollo.13$actor2))
```

```{r}
formula <- ~ 1 + 
  remstats::inertia(scaling = "std") + # Endogenous statistics
  remstats::outdegreeSender(scaling='std') # Endogenous statistics
```

```{r}
# set up the covariates
covar <- data.frame(id = 1:16, time = 0)
```

```{r}
# compute the statistics
out <- remstats(tie_effects = formula, edgelist = Apollo.13, actors = 16)

# extract the statistics from the list
stat <- out[["statistics"]]
```

```{r}
# maximum time point of each iteration of REH
tau <- max(Apollo.13$time)

# specify the length of the window
windows <- REHdynamics::createwindows(1000, tau, overlap = 2/3)

# fit to the REM model
model_fixwin <- REHdynamics::MWrem(windows, edgelist = Apollo.13, 
                                   stats = stat,
                                   actors = covar$id, directed = TRUE, 
                                   method = "MLE", model = "tie", ncores = 2)
dim(Apollo.13)
dim(stat)
is.na(Apollo.13)
```


```{r}
# extract the parameters
fixmw_ine_param <- 1
for (i in 34:length(model_fixwin)) {
  fixmw_ine_param[i] <- model_fixwin[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_param, type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_param <- 1
for (i in 34:length(model_fixwin)) {
  fixmw_out_param[i] <- model_fixwin[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_param, type = "point") # plot the movement of parameter
```

```{r}
# changepoint 42424.8 second

PELT_fixmw_ine <- cpt.meanvar(fixmw_ine_param[34:148], method="PELT")

PELT_fixmw_ine@cpts[-length(PELT_fixmw_ine@cpts)] + 34

```

```{r}
PELT_fixmw_out <- cpt.meanvar(fixmw_out_param[34:148], method="PELT")

PELT_fixmw_out@cpts[-length(PELT_fixmw_out@cpts)] + 34
```



















1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin <- ddwindows(edgelist = Apollo.13, tie_effects = formula, mintime = 2000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin_1cp_diff.all <- MWrem(windows = ddwin_1cp_diff.all$windows, edgelist = reh_1cp_diff.all, 
		stats = stat.1cp_diff.all, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_send_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["send.z"]]
}
plot(ddmw_send_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_diff_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_ine_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_reci_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```
```








