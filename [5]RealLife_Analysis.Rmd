---
title: "Untitled"
author: "Hsuan Lee"
output: pdf_document
---

```{r}
library(remstats) # the formula for REH
library(relevent) # fit REH to REM
library(REHdynamics) # fit the moving window REM
library(ocp) # package for BOCD
library(changepoint) # package for PELT, BS
set.seed(9252568)
```

# Load the data

```{r}
# Load data using load():
load("RealLife_Data/Merged_ALL_parts_Apollo.rdata")

# change the name of dataset, only leave time and actors infomation
Apollo.13 <- Merged_ALL_parts_Apollo[, -c(4,5)]

# change the names of columns
colnames(Apollo.13) <- c("time", "actor1", "actor2")
```

# Fit the REM

## Step 1: Assign the formula that indicates which effects shoould contain in the model
```{r}
formula <- ~ 1 + 
  remstats::inertia(scaling = "std") +
  remstats::outdegreeSender(scaling= "std") +
  remstats::reciprocity(scaling = "std") +
  remstats::totaldegreeSender(scaling = "std") +
  remstats::psABBA(consider_type = FALSE) +
  remstats::psABXA(consider_type = FALSE) +
  remstats::psABBY(consider_type = FALSE)

covar <- data.frame(id = 1:19, time = 0)
```

## Step 2: Compute the statistics
```{r}
out <- remstats(tie_effects = formula, edgelist = Apollo.13, actors = 19)
stat <- out[["statistics"]] # extract the statistics from the list
```

## Step 3: Fit the windows on the REH

Compute the optimal lengths of the windows (data-driven MW)
```{r}
# obtain data-driven window widths
#ddwin <- ddwindows(edgelist = Apollo.13, tie_effects = formula, mintime = 1000, 
#                   covar = covar)
```

Save the DDMW, as it takes long time to run (15 hours)
```{r}
#saveRDS(object = ddwin, file = "Apollo.13_ddwin.RDS")
```

Read the DDMW file
```{r}
ddmw <- readRDS("Apollo.13_ddwin.RDS")
```

Extract the windows
```{r}

ddmw[["options"]][[i]][["begin"]][1]
ddmw[["options"]][[i]][["end"]][length(ddmw[["options"]][[i]][["end"]])]
```

























Fit the REM by windows
```{r}
# fits a moving window relational event model
model_ddwin <- MWrem(windows = ddmw$windows, edgelist = Apollo.13, 
		                 stats = stat, actors = covar$id, directed = TRUE)
```

-----------------
Fit the fix MWREM
```{r}
# changepoint 201321 second

# maximum time point of each iteration of REH
tau <- max(Apollo.13$time)

# specify the length of the window
windows <- REHdynamics::createwindows(1000, tau, overlap = 2/3)

# fit to the REM model
model_fixwin <- REHdynamics::MWrem(windows, edgelist = Apollo.13, 
                                   stats = stat,
                                   actors = covar$id, directed = TRUE, 
                                   method = "MLE", model = "tie", ncores = 2)
```

```{r}
# extract the parameters
fixmw_ine_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_ine_param[i] <- model_fixwin[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_out_param[i] <- model_fixwin[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_rec_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_rec_param[i] <- model_fixwin[[i]][["coefficients"]][["reciprocity"]]
}
plot(fixmw_rec_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_totSend_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_totSend_param[i] <- model_fixwin[[i]][["coefficients"]][["totaldegreeSender"]]
}
plot(fixmw_totSend_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_psABBA_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_psABBA_param[i] <- model_fixwin[[i]][["coefficients"]][["psABBA"]]
}
plot(fixmw_psABBA_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_psABXA_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_psABXA_param[i] <- model_fixwin[[i]][["coefficients"]][["psABXA"]]
}
plot(fixmw_psABXA_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_psABBY_param <- 1
for (i in 593:length(model_fixwin)) {
  fixmw_psABBY_param[i] <- model_fixwin[[i]][["coefficients"]][["psABBY"]]
}
plot(fixmw_psABBY_param[593:length(model_fixwin)], type = "point") # plot the movement of parameter
```






```{r}
PELT_fixmw_ine <- cpt.meanvar(fixmw_ine_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_ine@cpts[-length(PELT_fixmw_ine@cpts)] + 593

```

```{r}
PELT_fixmw_out <- cpt.meanvar(fixmw_out_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_out@cpts[-length(PELT_fixmw_out@cpts)] + 593
```

```{r}
PELT_fixmw_rec <- cpt.meanvar(fixmw_rec_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_rec@cpts[-length(PELT_fixmw_rec@cpts)] + 593
```

```{r}
PELT_fixmw_totSend <- cpt.meanvar(fixmw_totSend_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_totSend@cpts[-length(PELT_fixmw_totSend@cpts)] + 593
```

```{r}
PELT_fixmw_psABBA <- cpt.meanvar(fixmw_psABBA_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_psABBA@cpts[-length(PELT_fixmw_psABBA@cpts)] + 593
```

```{r}
PELT_fixmw_psABXA <- cpt.meanvar(fixmw_psABXA_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_psABXA@cpts[-length(PELT_fixmw_psABXA@cpts)] + 593
```

```{r}
PELT_fixmw_psABBY <- cpt.meanvar(fixmw_psABBY_param[593:length(model_fixwin)], method="PELT")

PELT_fixmw_psABBY@cpts[-length(PELT_fixmw_psABBY@cpts)] + 593
```

















```{r}
BOCD_fixmw_ine_param <- onlineCPD(fixmw_ine_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_ine <- BOCD_fixmw_ine_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_ine <- locat_BOCD_ine[-1])

plot(BOCD_fixmw_ine_param)
```

```{r}
BOCD_fixmw_out_param <- onlineCPD(fixmw_out_param[593:length(model_fixwin)], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_out <- BOCD_fixmw_out_param[["changepoint_lists"]][["maxCPs"]][[1]] +593
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_out <- locat_BOCD_out[-1])

plot(BOCD_fixmw_out_param)
```






















































```{r}
# Load data using load():
load("RealLife_Data/Merged_ALL_parts_Apollo.rdata")

Apollo13 <- read.csv("RealLife_Data/Apollo13.csv", sep =';')
```

## Represent the names of actors by number
```{r}
Apollo13$sender <- as.numeric(c("CDR" = "1", 
                                "CAPCOM" = "2", 
                                "FLIGHT" = "3", 
                                "EECOM" = "4", 
                                "GNC" = "5", 
                                "INCO" = "6", 
                                "CMP" = "7", 
                                "CONTROL" = "8", 
                                "TELMU" = "9", 
                                "GUIDO" = "10", 
                                "LMP" = "11", 
                                "FDO" = "12", 
                                "NETWORK" = "13", 
                                "AFD" = "14", 
                                "RECOVERY" = "15", 
                                "FAO" = "16", 
                                "RETRO" = "17", 
                                "PROCEDURES" = "18", 
                                "SURGEON" = "19", 
                                "SC" = "20", 
                                "MS" = "21", 
                                "MCC" = "22", 
                                "CT" = "23", 
                                "IWO" = "24", 
                                "R" = "25", 
                                "P" = "26", 
                                "ARIA" = "27", 
                                "R1" = "28", 
                                "S" = "29")[Apollo13$sender])
```

```{r}
Apollo13$receiver <- as.numeric(c("CDR" = "1", 
                                  "CAPCOM" = "2", 
                                  "FLIGHT" = "3", 
                                  "EECOM" = "4", 
                                  "GNC" = "5", 
                                  "INCO" = "6", 
                                  "CMP" = "7", 
                                  "CONTROL" = "8", 
                                  "TELMU" = "9", 
                                  "GUIDO" = "10", 
                                  "LMP" = "11", 
                                  "FDO" = "12", 
                                  "NETWORK" = "13", 
                                  "AFD" = "14", 
                                  "RECOVERY" = "15", 
                                  "FAO" = "16", 
                                  "RETRO" = "17", 
                                  "PROCEDURES" = "18", 
                                  "SURGEON" = "19", 
                                  "SC" = "20", 
                                  "MS" = "21", 
                                  "MCC" = "22", 
                                  "CT" = "23", 
                                  "IWO" = "24", 
                                  "R" = "25", 
                                  "P" = "26", 
                                  "ARIA" = "27", 
                                  "R1" = "28", 
                                  "S" = "29", 
                                  "ALL" = "30")[Apollo13$receiver])
```

## Remove the messages, only leave time, and actors information
```{r}
# remove messages column
Apollo13 <- Apollo13[,-3]

# rename the columns
colnames(Apollo13) <- c("time", "actor1", "actor2")
```

## We only take first 6500 events into account, as the CP we known is at 42424.8 second, we dont need the whole dataset
```{r}
#Apollo13 <- Apollo13[1:6500, ]
```

# Fit the REM

## Step 1: Assign the formula that indicates which effects shoould contain in the model
```{r}
formula <- ~ 1 + 
  remstats::inertia(scaling = "std") +
  remstats::outdegreeSender(scaling= "std") +
  remstats::reciprocity(scaling = "std") +
  remstats::totaldegreeSender(scaling = "std") +
  remstats::psABBA(consider_type = FALSE) +
  remstats::psABXA(consider_type = FALSE) +
  remstats::psABBY(consider_type = FALSE)

covar <- data.frame(id = 1:30, time = 0)
```

## Step 2: Compute the statistics
```{r}
out <- remstats(tie_effects = formula, edgelist = Apollo13, actors = 30)
stat <- out[["statistics"]] # extract the statistics from the list
```

## Step 3: Fit the windows on the REH

Compute the optimal lengths of the windows (data-driven MW)
```{r}
# obtain data-driven window widths
#ddwin <- ddwindows(edgelist = Apollo13, tie_effects = formula, mintime = 1000, 
#                   covar = covar)
```

Fit the REM by windows
```{r}
#  fits a moving window relational event model
#model_ddwin <- MWrem(windows = ddwin$windows, edgelist = Apollo13, 
#		                 stats = stat, actors = covar$id, directed = TRUE)
```

-----------------
Fit the fix MWREM
```{r}
# maximum time point of each iteration of REH
tau <- max(Apollo13$time)

# specify the length of the window
windows <- REHdynamics::createwindows(1000, tau, overlap = 2/3)

# fit to the REM model
model_fixwin <- REHdynamics::MWrem(windows, edgelist = Apollo13, 
                                   stats = stat,
                                   actors = covar$id, directed = TRUE, 
                                   method = "MLE", model = "tie", ncores = 2)
```

Don't know why, i can only use `inertia` and `outdegreeSender`











```{r}
# extract the parameters
fixmw_ine_param <- 1
for (i in 34:length(model_fixwin)) {
  fixmw_ine_param[i] <- model_fixwin[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_param, type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_param <- 1
for (i in 1:length(model_fixwin)) {
  fixmw_out_param[i] <- model_fixwin[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_param, type = "point") # plot the movement of parameter
```











Extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_param <- 1
for (i in 34:length(model_ddwin)) {
  ddmw_send_param[i] <- model_ddwin[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_send_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_diff_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_ine_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_reci_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```


























```{r}
# maximum time point of each iteration of REH
tau <- max(Apollo13$time)

# specify the length of the window
windows <- REHdynamics::createwindows(1000, tau, overlap = 2/3)

# fit to the REM model
model_fixwin <- REHdynamics::MWrem(windows, edgelist = Apollo13, 
                                   stats = stat,
                                   actors = covar$id, directed = TRUE, 
                                   method = "MLE", model = "tie", ncores = 2)
```

```{r}
Apollo13$actor1 <- as.numeric(Apollo13$actor1)
Apollo13$actor2 <- as.numeric(Apollo13$actor2)

sort(unique(Apollo13$actor1))
sort(unique(Apollo13$actor2))
```








































```{r}
Apollo.13 <- readRDS(file = "RealLife_Data/PartOfApollo_13.RDS")

colnames(Apollo.13) <- c("time", "actor1", "actor2")

Apollo.13$actor1[Apollo.13$actor1 == 17] <- 14
Apollo.13$actor1[Apollo.13$actor1 == 18] <- 15
Apollo.13$actor1[Apollo.13$actor1 == 19] <- 16

Apollo.13$actor2[Apollo.13$actor2 == 17] <- 14
Apollo.13$actor2[Apollo.13$actor2 == 18] <- 15
Apollo.13$actor2[Apollo.13$actor2 == 19] <- 16

sort(unique(Apollo.13$actor1))
sort(unique(Apollo.13$actor2))
```

```{r}
formula <- ~ 1 + 
  remstats::inertia(scaling = "std") + # Endogenous statistics
  remstats::outdegreeSender(scaling='std') # Endogenous statistics
```

```{r}
# set up the covariates
covar <- data.frame(id = 1:16, time = 0)
```

```{r}
# compute the statistics
out <- remstats(tie_effects = formula, edgelist = Apollo.13, actors = 16)

# extract the statistics from the list
stat <- out[["statistics"]]
```

```{r}
# maximum time point of each iteration of REH
tau <- max(Apollo.13$time)

# specify the length of the window
windows <- REHdynamics::createwindows(1000, tau, overlap = 2/3)

# fit to the REM model
model_fixwin <- REHdynamics::MWrem(windows, edgelist = Apollo.13, 
                                   stats = stat,
                                   actors = covar$id, directed = TRUE, 
                                   method = "MLE", model = "tie", ncores = 2)
dim(Apollo.13)
dim(stat)
is.na(Apollo.13)
```


```{r}
# extract the parameters
fixmw_ine_param <- 1
for (i in 34:length(model_fixwin)) {
  fixmw_ine_param[i] <- model_fixwin[[i]][["coefficients"]][["inertia"]]
}
plot(fixmw_ine_param, type = "point") # plot the movement of parameter
```

```{r}
# extract the parameters
fixmw_out_param <- 1
for (i in 34:length(model_fixwin)) {
  fixmw_out_param[i] <- model_fixwin[[i]][["coefficients"]][["outdegreeSender"]]
}
plot(fixmw_out_param, type = "point") # plot the movement of parameter
```

```{r}
# changepoint 42424.8 second

PELT_fixmw_ine <- cpt.meanvar(fixmw_ine_param[34:148], method="PELT")

PELT_fixmw_ine@cpts[-length(PELT_fixmw_ine@cpts)] + 34

```

```{r}
PELT_fixmw_out <- cpt.meanvar(fixmw_out_param[34:148], method="PELT")

PELT_fixmw_out@cpts[-length(PELT_fixmw_out@cpts)] + 34
```



```{r}
BOCD_fixmw_ine_param <- onlineCPD(fixmw_ine_param[34:148], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_ine <- BOCD_fixmw_ine_param[["changepoint_lists"]][["maxCPs"]][[1]] +34
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_ine <- locat_BOCD_ine[-1])

plot(BOCD_fixmw_ine_param)
```

```{r}
BOCD_fixmw_out_param <- onlineCPD(fixmw_out_param[34:148], 
                                            getR = T, 
                                            optionalOutputs = T, 
                                            truncRlim = 10^-4)

locat_BOCD_out <- BOCD_fixmw_out_param[["changepoint_lists"]][["maxCPs"]][[1]] +34
# remove the first value of the vector, as BOCPD function indicates the first window as CP all the time
(locat_BOCD_out <- locat_BOCD_out[-1])

plot(BOCD_fixmw_out_param)
```















1. Step 1: compute the optimal lengths of the windows
```{r}
# obtain data-driven window widths
ddwin <- ddwindows(edgelist = Apollo.13, tie_effects = formula, mintime = 1000, 
		covar = covar)
```

2. Step 2: fit the REM by windows
```{r}
#  fits a moving window relational event model
model_ddwin <- MWrem(windows = ddwin$windows, edgelist = Apollo.13, 
		stats = stat, actors = covar$id, directed = TRUE)
```

3. Step 3: extract the parameters by windows and plot them out
```{r}
# extract the parameters
ddmw_send_param <- 1
for (i in 34:length(model_ddwin)) {
  ddmw_send_param[i] <- model_ddwin[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_send_param, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_diff_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_diff_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["difference.z"]]
}
plot(ddmw_diff_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_ine_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_ine_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["inertia"]]
}
plot(ddmw_ine_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```

```{r}
# extract the parameters
ddmw_reci_1cp_param_diff.all <- 1
for (i in 1:length(model_ddwin_1cp_diff.all)) {
  ddmw_reci_1cp_param_diff.all[i] <- model_ddwin_1cp_diff.all[[i]][["coefficients"]][["reciprocity"]]
}
plot(ddmw_reci_1cp_param_diff.all, type = "lm") # plot the movement of parameter
```


















